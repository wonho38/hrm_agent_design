<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex-grow: 1;
        }

        .settings {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .setting-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .setting-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .control-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        select:hover {
            border-color: #007bff;
        }

        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .generate-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 20px;
        }

        .generate-btn:hover {
            background-color: #0056b3;
        }

        .generate-btn:active {
            transform: translateY(1px);
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 20px;
        }

        .top-textboxes {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .bottom-textboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .textbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
            position: relative; /* Ïª®ÌÖåÏù¥ÎÑà ÏúÑÏπò Í≥†Ï†ï */
        }

        .textbox-label {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        textarea {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background-color: white;
        }

        .readonly {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        .status-message {
            display: none;
            margin-left: 15px;
            color: #28a745;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 12px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #28a745;
            border-radius: 20px;
            animation: statusPulse 1.5s ease-in-out infinite;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
            align-items: center;
            gap: 8px;
        }

        .status-message.active {
            display: flex;
        }

        .status-message::before {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid #28a745;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: statusSpin 1s linear infinite;
        }

        @keyframes statusPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.02);
                box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            }
        }

        @keyframes statusSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .button-container {
            display: flex;
            align-items: center;
        }

        /* Header navigation links */
        .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .nav-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .nav-link:hover {
            background-color: #e7f3ff;
        }

        /* Formatted operation history styles */
        .formatted-op-history {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .formatted-op-history:hover {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background-color: white;
        }

        .op-history-title {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .op-history-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .op-history-item {
            margin: 12px 0;
            padding: 12px 15px;
            border-radius: 6px;
            position: relative;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .op-history-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .op-history-item.conclusion {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .op-history-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .op-history-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .op-history-item.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .op-history-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .op-history-text {
            display: inline;
        }

        .op-history-text strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .op-history-text em {
            color: #6c757d;
            font-style: normal;
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .format-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .format-toggle-btn:hover {
            opacity: 1;
        }

        /* Formatted user guide styles */
        .formatted-user-guide {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            transition: all 0.3s ease;
        }
        .formatted-user-guide:hover {
            border-color: #6f42c1;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
            background-color: white;
        }
        .user-guide-title {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-guide-list { margin: 0; padding-left: 18px; }
        .user-guide-item { margin: 10px 0; }
        .user-guide-source a { color: #6f42c1; text-decoration: none; }
        .user-guide-source a:hover { text-decoration: underline; }

        /* Formatted diagnosis styles - ÏÉàÎ°úÏö¥ Î∞ïÏä§ ÌòïÌÉú */
        .formatted-diagnosis {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .formatted-diagnosis:hover {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: white;
        }

        .diagnosis-title {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
            text-align: center;
        }

        /* Í≤∞Î°† Ïä§ÌÉÄÏùº */
        .diagnosis-conclusion {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .diagnosis-conclusion-label {
            font-weight: 700;
            font-size: 1.1em;
            color: #155724;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .diagnosis-conclusion-content {
            color: #155724;
            font-size: 1em;
            line-height: 1.5;
        }

        /* ÏßÑÎã® Ìï≠Î™©Îì§ Ïª®ÌÖåÏù¥ÎÑà */
        .diagnosis-items {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        /* Í∞úÎ≥Ñ ÏßÑÎã® Ìï≠Î™© */
        .diagnosis-item {
            display: flex;
            align-items: flex-start;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #28a745;
            transition: all 0.2s ease;
        }

        .diagnosis-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateX(2px);
        }

        .diagnosis-item.normal {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #f0f8f0 100%);
        }

        .diagnosis-item.abnormal {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #f8f0f0 100%);
        }

        .diagnosis-item.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffef8 0%, #faf8f0 100%);
        }

        .diagnosis-item.info {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #f8feff 0%, #f0f8fa 100%);
        }

        .diagnosis-item.recommendation {
            border-left-color: #6f42c1;
            background: linear-gradient(135deg, #faf8ff 0%, #f5f0ff 100%);
        }

        /* ÏßÑÎã® Ìï≠Î™© Î≤àÌò∏ */
        .diagnosis-item-number {
            background: #28a745;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .diagnosis-item.abnormal .diagnosis-item-number {
            background: #dc3545;
        }

        .diagnosis-item.warning .diagnosis-item-number {
            background: #ffc107;
            color: #212529;
        }

        .diagnosis-item.info .diagnosis-item-number {
            background: #17a2b8;
        }

        .diagnosis-item.recommendation .diagnosis-item-number {
            background: #6f42c1;
        }

        /* ÏßÑÎã® Ìï≠Î™© ÎÇ¥Ïö© */
        .diagnosis-item-content {
            flex: 1;
            color: #2c3e50;
            font-size: 0.95em;
            line-height: 1.5;
        }

        /* ÏßÑÎã® Î©îÏù∏ ÎÇ¥Ïö© */
        .diagnosis-main-content {
            margin-bottom: 8px;
        }

        /* ÏßÑÎã® ÌïòÏúÑ Ìï≠Î™©Îì§ */
        .diagnosis-sub-items {
            margin: 8px 0 0 0;
            padding-left: 20px;
            list-style: none;
        }

        .diagnosis-sub-item {
            position: relative;
            margin: 4px 0;
            padding-left: 15px;
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .diagnosis-sub-item::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            top: 0;
            color: #6c757d;
            font-weight: bold;
        }

        .diagnosis-sub-item:hover {
            color: #2c3e50;
        }

        /* Í∏∞ÌÉÄ Ìï≠Î™©Îì§ */
        .diagnosis-other-items {
            display: grid;
            gap: 10px;
        }

        .diagnosis-other-item {
            background: white;
            border-radius: 6px;
            padding: 12px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 3px solid #6c757d;
            transition: all 0.2s ease;
        }

        .diagnosis-other-item:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transform: translateX(1px);
        }

        .diagnosis-other-item.normal {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #f0f8f0 100%);
        }

        .diagnosis-other-item.abnormal {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #f8f0f0 100%);
        }

        .diagnosis-other-item.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffef8 0%, #faf8f0 100%);
        }

        .diagnosis-other-item.info {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #f8feff 0%, #f0f8fa 100%);
        }

        .diagnosis-other-item.recommendation {
            border-left-color: #6f42c1;
            background: linear-gradient(135deg, #faf8ff 0%, #f5f0ff 100%);
        }

        .diagnosis-other-content {
            color: #2c3e50;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Readability Report Styles */
        .readability-section {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border-left: 4px solid #007bff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            width: 100%;
            box-sizing: border-box;
            order: 10; /* Í∞ÄÎèÖÏÑ± ÏÑπÏÖòÏùÑ Í∞ÄÏû• ÏïÑÎûòÎ°ú */
        }

        .readability-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .readability-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .readability-toggle {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .readability-toggle:hover {
            background: #0056b3;
        }

        .readability-content {
            line-height: 1.6;
        }

        .readability-overall {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-weight: 600;
        }

        .readability-overall.good {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .readability-overall.poor {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .readability-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .readability-metric {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .readability-metric .icon {
            font-size: 1.1em;
        }

        .readability-terms {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .readability-terms-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .readability-terms-list {
            color: #6c757d;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .readability-recommendations {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
        }

        .readability-recommendations-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .readability-recommendations ul {
            margin: 0;
            padding-left: 20px;
            color: #856404;
        }

        .readability-recommendations li {
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .readability-collapsed {
            display: none;
        }

        @media (max-width: 768px) {
            .readability-metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-links">
                <a class="nav-link" href="/guide-retriever">Guide Retriever</a>
                <a class="nav-link" href="/data-review">Data Review</a>
                <a class="nav-link" href="/prompt-editor">Prompt Editor</a>
            </div>
            <h1 class="title">HRM AI Agent</h1>
            <div class="settings">
                <div class="setting-group">
                    <label class="setting-label">LLM:</label>
                    <select id="llmSelect">
                        <option value="aws">AWS</option>
                        <option value="openai">OpenAI</option>
                        <option value="gauss">Gauss</option>
                        <option value="gausso">Gausso</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Language:</label>
                    <select id="languageSelect">
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">Product:</label>
                <select id="productSelect">
                    <option value="airconditioner">Airconditioner</option>
                    <option value="refrigerator">Refrigerator</option>
                    <option value="washer">Washer</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">ID:</label>
                <select id="idSelect">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="button-container">
                <button class="generate-btn" id="generateBtn" onclick="generateContent()">Generation</button>
                <div class="spinner" id="loadingSpinner"></div>
                <div class="status-message" id="statusMessage"></div>
            </div>
        </div>

        <div class="content-area">
            <div class="top-textboxes">
                <div class="textbox-group">
                    <label class="textbox-label">Diagnosis Summarization</label>
                    <textarea id="diagnosisSummarization" placeholder="AIÍ∞Ä ÏÉùÏÑ±Ìïú ÏßÑÎã® ÏöîÏïΩÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">Op. History Summarization</label>
                    <textarea id="opHistorySummarization" placeholder="AIÍ∞Ä ÏÉùÏÑ±Ìïú Ïö¥ÏòÅ Ïù¥Î†• ÏöîÏïΩÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">User Guide</label>
                    <textarea id="userGuide" placeholder="AIÍ∞Ä ÏÉùÏÑ±Ìïú ÏÇ¨Ïö©Ïûê Í∞ÄÏù¥ÎìúÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..."></textarea>
                </div>
            </div>
            <div class="bottom-textboxes">
                <div class="textbox-group">
                    <label class="textbox-label">Diagnosis Lists</label>
                    <textarea id="diagnosisLists" class="readonly" readonly placeholder="ÏÑ†ÌÉùÎêú Ï†úÌíàÏùò ÏßÑÎã® Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">Operation History</label>
                    <textarea id="operationHistory" class="readonly" readonly placeholder="ÏÑ†ÌÉùÎêú Ï†úÌíàÏùò Ïö¥ÏòÅ Ïù¥Î†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let jsonData = [];

        // JSON Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadJsonData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                jsonData = await response.json();
                console.log('JSON data loaded:', jsonData.length, 'items');
                updateIdOptions();
            } catch (error) {
                console.error('Error loading JSON data:', error);
                document.getElementById('idSelect').innerHTML = '<option value="">Error loading data</option>';
            }
        }

        // ID ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updateIdOptions() {
            const productSelect = document.getElementById('productSelect');
            const idSelect = document.getElementById('idSelect');
            const selectedProduct = productSelect.value;
            
            // ÏÑ†ÌÉùÎêú Ï†úÌíàÏóê Ìï¥ÎãπÌïòÎäî IDÎì§ ÌïÑÌÑ∞ÎßÅ
            const filteredData = jsonData.filter(item => {
                if (selectedProduct === 'airconditioner') {
                    return item.id.startsWith('airconditioner_');
                } else if (selectedProduct === 'refrigerator') {
                    return item.id.startsWith('refrigerator_');
                } else if (selectedProduct === 'washer') {
                    return item.id.startsWith('washer_');
                }
                return false;
            });

            // ID ÏòµÏÖò ÏÉùÏÑ±
            idSelect.innerHTML = '';
            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.id;
                    idSelect.appendChild(option);
                });
            } else {
                // Ìï¥Îãπ Ï†úÌíà ÌÉÄÏûÖÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
                for (let i = 1; i <= 25; i++) {
                    const option = document.createElement('option');
                    const idNumber = String(i).padStart(3, '0');
                    option.value = `${selectedProduct}_${idNumber}`;
                    option.textContent = `${selectedProduct}_${idNumber}`;
                    idSelect.appendChild(option);
                }
            }
        }

        // Ï†úÌíà Î≥ÄÍ≤Ω Ïãú ID ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('productSelect').addEventListener('change', updateIdOptions);

        // ÏßÑÎã® ÏöîÏïΩ ÌõÑÏ≤òÎ¶¨ Ìï®Ïàò (ÏïÑÏù¥ÏΩò ÏóÜÎäî Î∞ïÏä§ ÌòïÌÉú)
        function formatDiagnosisSummary(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            
            let lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            // Ï≤´ Î≤àÏß∏ Ï§ÑÏóêÏÑú Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú Ï†úÍ±∞
            if (lines.length > 0) {
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú Ìå®ÌÑ¥Îì§
                    const languagePatterns = [
                        /^ÌïúÍµ≠Ïñ¥[:Ôºö\s]*(.*)$/gi,
                        /^ÏòÅÏñ¥[:Ôºö\s]*(.*)$/gi,
                        /^English[:Ôºö\s]*(.*)$/gi,
                        /^Korean[:Ôºö\s]*(.*)$/gi,
                        /^ÌïúÍ∏Ä[:Ôºö\s]*(.*)$/gi,
                        /^korean[:Ôºö\s]*(.*)$/gi,
                        /^english[:Ôºö\s]*(.*)$/gi,
                        /^(ÌïúÍµ≠Ïñ¥|ÏòÅÏñ¥|English|Korean|ÌïúÍ∏Ä|korean|english)[:Ôºö\-\s]+(.+)$/gi,
                        /^(ÌïúÍµ≠Ïñ¥|ÏòÅÏñ¥|English|Korean|ÌïúÍ∏Ä|korean|english)[:Ôºö\-\s]*$/gi
                    ];
                    
                    let cleanedLine = line;
                    let wasLanguageLine = false;
                    
                    for (const pattern of languagePatterns) {
                        const match = cleanedLine.match(pattern);
                        if (match) {
                            if (match[1] && match[1].trim()) {
                                cleanedLine = match[1].trim();
                            } else if (match[2] && match[2].trim()) {
                                cleanedLine = match[2].trim();
                            } else {
                                wasLanguageLine = true;
                                break;
                            }
                            break;
                        }
                    }
                    
                    if (!wasLanguageLine && cleanedLine && cleanedLine.length > 0) {
                        processedLines.push(cleanedLine);
                    }
                }
                
                lines = processedLines;
            }
            
            // Í≤∞Î°† Î∂ÄÎ∂ÑÍ≥º Î≤àÌò∏Í∞Ä ÏûàÎäî Ìï≠Î™©Îì§ Î∂ÑÎ¶¨
            let conclusionLine = '';
            let numberedItems = [];
            let otherItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                const trimmedLine = lines[i].trim();
                if (trimmedLine === '') continue;
                
                // Î≤àÌò∏Í∞Ä ÏûàÎäî Ï§Ñ Ï∞æÍ∏∞ (1., 2., 3. Îì±)
                const numberedMatch = trimmedLine.match(/^(\d+)\.\s*(.+)/);
                if (numberedMatch) {
                    // Î≤àÌò∏Í∞Ä ÏûàÎäî Ìï≠Î™© ÏÉùÏÑ±
                    const item = {
                        number: numberedMatch[1],
                        content: numberedMatch[2],
                        subItems: []
                    };
                    
                    // Îã§Ïùå Ï§ÑÎì§ÏóêÏÑú ÌïòÏù¥ÌîàÏúºÎ°ú ÏãúÏûëÌïòÎäî Í¥ÄÎ†® ÎÇ¥Ïö© Ï∞æÍ∏∞
                    let j = i + 1;
                    while (j < lines.length) {
                        const nextLine = lines[j].trim();
                        if (nextLine === '') {
                            j++;
                            continue;
                        }
                        
                        // ÌïòÏù¥ÌîàÏúºÎ°ú ÏãúÏûëÌïòÎäî Ï§ÑÏù¥Í±∞ÎÇò Îì§Ïó¨Ïì∞Í∏∞Îêú Ï§Ñ
                        if (nextLine.match(/^[-‚Äì‚Äî‚Ä¢]\s*(.+)/) || nextLine.match(/^\s+[-‚Äì‚Äî‚Ä¢]\s*(.+)/) || 
                            (nextLine.match(/^\s{2,}(.+)/) && !nextLine.match(/^\d+\.\s/))) {
                            item.subItems.push(nextLine);
                            j++;
                        } else if (nextLine.match(/^\d+\.\s/)) {
                            // Îã§Ïùå Î≤àÌò∏ Ìï≠Î™©ÏùÑ ÎßåÎÇòÎ©¥ Ï§ëÎã®
                            break;
                        } else {
                            // ÏùºÎ∞ò ÌÖçÏä§Ìä∏ÏßÄÎßå Î≤àÌò∏ Ìï≠Î™©Ïù¥ ÏïÑÎãàÎ©¥ ÌïòÏúÑ Ìï≠Î™©ÏúºÎ°ú Ìè¨Ìï®
                            item.subItems.push(nextLine);
                            j++;
                        }
                    }
                    
                    numberedItems.push(item);
                    i = j - 1; // Ï≤òÎ¶¨Ìïú Ï§ÑÎì§ Í±¥ÎÑàÎõ∞Í∏∞
                } else if (i === 0 && !numberedMatch) {
                    // Ï≤´ Î≤àÏß∏ Ï§ÑÏù¥ Î≤àÌò∏Í∞Ä ÏóÜÏúºÎ©¥ Í≤∞Î°†ÏúºÎ°ú Ï≤òÎ¶¨
                    conclusionLine = trimmedLine;
                } else {
                    // Í∑∏ Ïô∏ Ìï≠Î™©Îì§ (Î≤àÌò∏ Ìï≠Î™©Ïóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞Îßå)
                    let isPartOfNumberedItem = false;
                    
                    // Ïù¥ÎØ∏ Î≤àÌò∏ Ìï≠Î™©Ïóê Ìè¨Ìï®ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                    for (let item of numberedItems) {
                        if (item.subItems.includes(trimmedLine)) {
                            isPartOfNumberedItem = true;
                            break;
                        }
                    }
                    
                    if (!isPartOfNumberedItem) {
                        otherItems.push(trimmedLine);
                    }
                }
            }
            
            let result = `
                <div class="formatted-diagnosis">
                    <h3 class="diagnosis-title">
                        <span>ÏßÑÎã® Î∂ÑÏÑù Í≤∞Í≥º</span>
                    </h3>
            `;
            
            // Í≤∞Î°† Î∂ÄÎ∂Ñ ÌëúÏãú
            if (conclusionLine) {
                const processedConclusion = processTextFormatting(conclusionLine);
                result += `
                    <div class="diagnosis-conclusion">
                        <div class="diagnosis-conclusion-label">Í≤∞Î°†</div>
                        <div class="diagnosis-conclusion-content">${processedConclusion}</div>
                    </div>
                `;
            }
            
            // Î≤àÌò∏Í∞Ä ÏûàÎäî Ìï≠Î™©Îì§ ÌëúÏãú
            if (numberedItems.length > 0) {
                result += `<div class="diagnosis-items">`;
                
                numberedItems.forEach(item => {
                    const processedContent = processTextFormatting(item.content);
                    let cssClass = getDiagnosisItemClass(item.content);
                    
                    // ÌïòÏúÑ Ìï≠Î™©Îì§ Ï≤òÎ¶¨
                    let subItemsHtml = '';
                    if (item.subItems && item.subItems.length > 0) {
                        subItemsHtml = '<ul class="diagnosis-sub-items">';
                        item.subItems.forEach(subItem => {
                            const processedSubItem = processTextFormatting(subItem);
                            // ÌïòÏù¥ÌîàÏù¥ÎÇò Î∂àÎ¶ø Ìè¨Ïù∏Ìä∏ Ï†úÍ±∞ÌïòÍ≥† Ï†ïÎ¶¨
                            const cleanSubItem = processedSubItem.replace(/^[-‚Äì‚Äî‚Ä¢]\s*/, '').replace(/^\s+[-‚Äì‚Äî‚Ä¢]\s*/, '').trim();
                            subItemsHtml += `<li class="diagnosis-sub-item">${cleanSubItem}</li>`;
                        });
                        subItemsHtml += '</ul>';
                    }
                    
                    result += `
                        <div class="diagnosis-item ${cssClass}">
                            <div class="diagnosis-item-number">${item.number}</div>
                            <div class="diagnosis-item-content">
                                <div class="diagnosis-main-content">${processedContent}</div>
                                ${subItemsHtml}
                            </div>
                        </div>
                    `;
                });
                
                result += `</div>`;
            }
            
            // Í∏∞ÌÉÄ Ìï≠Î™©Îì§ ÌëúÏãú
            if (otherItems.length > 0) {
                result += `<div class="diagnosis-other-items">`;
                
                otherItems.forEach(item => {
                    const processedContent = processTextFormatting(item);
                    let cssClass = getDiagnosisItemClass(item);
                    
                    result += `
                        <div class="diagnosis-other-item ${cssClass}">
                            <div class="diagnosis-other-content">${processedContent}</div>
                        </div>
                    `;
                });
                
                result += `</div>`;
            }
            
            result += `</div>`;
            
            return result;
        }
        
        // ÏßÑÎã® Ìï≠Î™©Ïùò CSS ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï (ÌÇ§ÏõåÎìú Í∏∞Î∞ò)
        function getDiagnosisItemClass(content) {
            const lowerContent = content.toLowerCase();
            
            if (lowerContent.includes('Ï†ïÏÉÅ') || lowerContent.includes('normal') || 
                lowerContent.includes('ÏñëÌò∏') || lowerContent.includes('good') ||
                lowerContent.includes('Î¨∏Ï†úÏóÜÏùå') || lowerContent.includes('Ï†ïÏÉÅ ÎèôÏûë')) {
                return 'normal';
            } else if (lowerContent.includes('Ïù¥ÏÉÅ') || lowerContent.includes('abnormal') || 
                      lowerContent.includes('Î¨∏Ï†ú') || lowerContent.includes('Ïò§Î•ò') || 
                      lowerContent.includes('error') || lowerContent.includes('fault') ||
                      lowerContent.includes('Í≥†Ïû•') || lowerContent.includes('Î∂àÎüâ')) {
                return 'abnormal';
            } else if (lowerContent.includes('Í∂åÏû•') || lowerContent.includes('recommend') || 
                      lowerContent.includes('Ï°∞Ïπò') || lowerContent.includes('action') ||
                      lowerContent.includes('Í∞úÏÑ†') || lowerContent.includes('improve') ||
                      lowerContent.includes('ÍµêÏ≤¥') || lowerContent.includes('Ï≤≠ÏÜå') ||
                      lowerContent.includes('Ï†êÍ≤Ä') || lowerContent.includes('ÌôïÏù∏')) {
                return 'recommendation';
            } else if (lowerContent.includes('Ï£ºÏùò') || lowerContent.includes('warning') || 
                      lowerContent.includes('Í≤ΩÍ≥†') || lowerContent.includes('alert') ||
                      lowerContent.includes('ÏúÑÌóò') || lowerContent.includes('risk')) {
                return 'warning';
            } else {
                return 'info';
            }
        }

        // ÏßÑÎã® Ìè¨Îß∑ÌåÖ Ï†ÅÏö© Ìï®Ïàò
        function applyDiagnosisFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            
            const parent = textarea.parentNode;
            
            // Í∏∞Ï°¥ Ìè¨Îß∑Îêú ÏöîÏÜåÎì§ Ï†úÍ±∞ (Í∞ÄÎèÖÏÑ± ÏÑπÏÖòÏùÄ Ïú†ÏßÄ)
            const existingFormatted = parent.querySelector('.formatted-diagnosis');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existingFormatted) existingFormatted.remove();
            if (existingToggle) existingToggle.remove();
            
            // Ìè¨Îß∑Îêú div ÏÉùÏÑ±
            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatDiagnosisSummary(rawText);
            
            // ÌÜ†Í∏Ä Î≤ÑÌäº ÏÉùÏÑ±
            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ÏõêÎ≥∏';
            toggleButton.title = 'ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ Î≥¥Í∏∞/Ïà®Í∏∞Í∏∞';
            
            // Í∞ÄÎèÖÏÑ± ÏÑπÏÖòÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            const readabilitySection = parent.querySelector('.readability-section');
            
            // textarea Ïà®Í∏∞Í≥† Ìè¨Îß∑Îêú divÏôÄ Î≤ÑÌäº Ï∂îÍ∞Ä
            textarea.style.display = 'none';
            
            // Í∞ÄÎèÖÏÑ± ÏÑπÏÖòÏù¥ ÏûàÏúºÎ©¥ Í∑∏ ÏïûÏóê Ï∂îÍ∞Ä, ÏóÜÏúºÎ©¥ Îß® Îí§Ïóê Ï∂îÍ∞Ä
            if (readabilitySection) {
                parent.insertBefore(formattedDiv, readabilitySection);
                parent.insertBefore(toggleButton, readabilitySection);
            } else {
                parent.appendChild(formattedDiv);
                parent.appendChild(toggleButton);
            }
            
            // ÌÜ†Í∏Ä Í∏∞Îä•
            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'Ìè¨Îß∑';
                    toggleButton.title = 'Ìè¨Îß∑Îêú Î≥¥Í∏∞Î°ú Ï†ÑÌôò';
                    showingFormatted = false;
                } else {
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ÏõêÎ≥∏';
                    toggleButton.title = 'ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ Î≥¥Í∏∞Î°ú Ï†ÑÌôò';
                    showingFormatted = true;
                }
            }
            
            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
            
            const formattedContent = formattedDiv.querySelector('.formatted-diagnosis');
            if (formattedContent) {
                formattedContent.title = 'ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÎ©¥ ÏõêÎ≥∏ ÌÖçÏä§Ìä∏Î•º Î≥º Ïàò ÏûàÏäµÎãàÎã§';
            }
        }

        // Ïö¥ÏòÅ Ïù¥Î†• ÏöîÏïΩ ÌõÑÏ≤òÎ¶¨ Ìï®Ïàò
        function formatOperationHistorySummary(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            
            // HTML ÏóîÌã∞Ìã∞ Ïù¥Ïä§ÏºÄÏù¥ÌîÑ
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            let lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            // Ï≤´ Î≤àÏß∏ Ï§ÑÏóêÏÑú Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú Ï†úÍ±∞ (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ)
            if (lines.length > 0) {
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú Ìå®ÌÑ¥Îì§ (Îçî Ìè¨Í¥ÑÏ†Å)
                    const languagePatterns = [
                        /^ÌïúÍµ≠Ïñ¥[:Ôºö\s]*(.*)$/gi,
                        /^ÏòÅÏñ¥[:Ôºö\s]*(.*)$/gi,
                        /^English[:Ôºö\s]*(.*)$/gi,
                        /^Korean[:Ôºö\s]*(.*)$/gi,
                        /^ÌïúÍ∏Ä[:Ôºö\s]*(.*)$/gi,
                        /^korean[:Ôºö\s]*(.*)$/gi,
                        /^english[:Ôºö\s]*(.*)$/gi,
                        // Ï§Ñ ÏãúÏûë Î∂ÄÎ∂ÑÏùò Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú
                        /^(ÌïúÍµ≠Ïñ¥|ÏòÅÏñ¥|English|Korean|ÌïúÍ∏Ä|korean|english)[:Ôºö\-\s]+(.+)$/gi,
                        // Ï§Ñ Ï†ÑÏ≤¥Í∞Ä Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìúÏù∏ Í≤ΩÏö∞
                        /^(ÌïúÍµ≠Ïñ¥|ÏòÅÏñ¥|English|Korean|ÌïúÍ∏Ä|korean|english)[:Ôºö\-\s]*$/gi
                    ];
                    
                    let cleanedLine = line;
                    let wasLanguageLine = false;
                    
                    // Í∞Å Ìå®ÌÑ¥ÏùÑ ÌôïÏù∏ÌïòÏó¨ Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú Ï†úÍ±∞
                    for (const pattern of languagePatterns) {
                        const match = cleanedLine.match(pattern);
                        if (match) {
                            if (match[1] && match[1].trim()) {
                                // Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìú Îí§Ïóê ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ Í∑∏ ÎÇ¥Ïö©Îßå Ïú†ÏßÄ
                                cleanedLine = match[1].trim();
                            } else if (match[2] && match[2].trim()) {
                                // Îëê Î≤àÏß∏ Ï∫°Ï≤ò Í∑∏Î£πÏóê ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö©
                                cleanedLine = match[2].trim();
                            } else {
                                // Ïñ∏Ïñ¥ ÌÇ§ÏõåÎìúÎßå ÏûàÍ≥† ÎÇ¥Ïö©Ïù¥ ÏóÜÏúºÎ©¥ Ïù¥ Ï§ÑÏùÑ Í±¥ÎÑàÎúÄ
                                wasLanguageLine = true;
                                break;
                            }
                            break;
                        }
                    }
                    
                    // Ïú†Ìö®Ìïú ÎÇ¥Ïö©Ïù¥ ÏûàÎäî Ï§ÑÎßå Ï∂îÍ∞Ä
                    if (!wasLanguageLine && cleanedLine && cleanedLine.length > 0) {
                        processedLines.push(cleanedLine);
                    }
                }
                
                lines = processedLines;
            }
            
            let result = `
                <div class="formatted-op-history">
                    <h3 class="op-history-title">
                        <span>üîç</span>
                        <span>Ïö¥ÏòÅ Ïù¥Î†• Î∂ÑÏÑù Í≤∞Í≥º</span>
                        <span style="margin-left: auto; font-size: 0.8em; color: #6c757d;">üìà</span>
                    </h3>
                    <ul class="op-history-list">
            `;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') return;
                
                let cssClass = '';
                let icon = '‚ñ∂';
                let processedLine = trimmedLine;
                
                // Î≤àÌò∏Í∞Ä ÏûàÎäî Ï§Ñ Ï≤òÎ¶¨ (1., 2., 3. Îì±)
                const numberedMatch = processedLine.match(/^(\d+)\.\s*(.+)/);
                if (numberedMatch) {
                    processedLine = numberedMatch[2];
                    
                    // Ï≤´ Î≤àÏß∏ Ìï≠Î™©ÏùÄ Î≥¥ÌÜµ Í≤∞Î°†
                    if (numberedMatch[1] === '1') {
                        cssClass = 'conclusion';
                        icon = '‚úì';
                    }
                }
                
                // ÌÇ§ÏõåÎìú Í∏∞Î∞ò Î∂ÑÎ•ò Î∞è ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
                const lowerLine = processedLine.toLowerCase();
                
                // Ï†ïÏÉÅ/ÏÑ±Í≥µ ÏÉÅÌÉú
                if (lowerLine.includes('Ï†ïÏÉÅ') || lowerLine.includes('normal') || 
                    lowerLine.includes('ÏÑ±Í≥µ') || lowerLine.includes('ÏôÑÎ£å') || 
                    lowerLine.includes('ÏñëÌò∏') || lowerLine.includes('success')) {
                    cssClass = 'conclusion';
                    icon = '‚úÖ';
                    
                // Ïò§Î•ò/Î¨∏Ï†ú ÏÉÅÌÉú  
                } else if (lowerLine.includes('Ïù¥ÏÉÅ') || lowerLine.includes('abnormal') || 
                          lowerLine.includes('Î¨∏Ï†ú') || lowerLine.includes('Ïò§Î•ò') || 
                          lowerLine.includes('error') || lowerLine.includes('fault') ||
                          lowerLine.includes('Ïã§Ìå®') || lowerLine.includes('Í≥†Ïû•')) {
                    cssClass = 'error';
                    icon = 'üö®';
                    
                // Í≤ΩÍ≥†/Ï£ºÏùò ÏÉÅÌÉú
                } else if (lowerLine.includes('Ï£ºÏùò') || lowerLine.includes('warning') || 
                          lowerLine.includes('ÌôïÏù∏') || lowerLine.includes('Ï†êÍ≤Ä') ||
                          lowerLine.includes('Í∂åÏû•') || lowerLine.includes('recommend') ||
                          lowerLine.includes('ÏïåÎ¶º') || lowerLine.includes('notice')) {
                    cssClass = 'warning';
                    icon = '‚ö†Ô∏è';
                    
                // Ïò®ÎèÑ Í¥ÄÎ†®
                } else if (lowerLine.includes('Ïò®ÎèÑ') || lowerLine.includes('temperature') ||
                          lowerLine.includes('‚ÑÉ') || lowerLine.includes('¬∞c') ||
                          lowerLine.includes('Ïó¥') || lowerLine.includes('ÎÉâÍ∞Å')) {
                    cssClass = 'info';
                    icon = 'üå°Ô∏è';
                    
                // Ï†ÑÎ†•/ÏóêÎÑàÏßÄ Í¥ÄÎ†®
                } else if (lowerLine.includes('Ï†ÑÎ†•') || lowerLine.includes('power') ||
                          lowerLine.includes('ÏóêÎÑàÏßÄ') || lowerLine.includes('energy') ||
                          lowerLine.includes('kw') || lowerLine.includes('Ï†ÑÍ∏∞')) {
                    cssClass = 'info';
                    icon = '‚ö°';
                    
                // ÏãúÍ∞Ñ/Ï£ºÍ∏∞ Í¥ÄÎ†®
                } else if (lowerLine.includes('ÏãúÍ∞Ñ') || lowerLine.includes('time') ||
                          lowerLine.includes('Ï£ºÍ∏∞') || lowerLine.includes('cycle') ||
                          lowerLine.includes('Î∂Ñ') || lowerLine.includes('Ï¥à')) {
                    cssClass = 'info';
                    icon = '‚è∞';
                    
                // Îç∞Ïù¥ÌÑ∞/Ï†ïÎ≥¥ Í¥ÄÎ†®
                } else if (lowerLine.includes('Îç∞Ïù¥ÌÑ∞') || lowerLine.includes('Ï†ïÎ≥¥') || 
                          lowerLine.includes('Ï∏°Ï†ï') || lowerLine.includes('Í∏∞Î°ù') ||
                          lowerLine.includes('data') || lowerLine.includes('info') ||
                          lowerLine.includes('Î°úÍ∑∏') || lowerLine.includes('Í∏∞Î°ù')) {
                    cssClass = 'info';
                    icon = 'üìä';
                    
                // Î∂ÄÏ°±/ÏóÜÏùå ÏÉÅÌÉú
                } else if (lowerLine.includes('Î∂ÄÏ°±') || lowerLine.includes('ÏóÜÏùå') ||
                          lowerLine.includes('insufficient') || lowerLine.includes('lack') ||
                          lowerLine.includes('missing') || lowerLine.includes('Î∂ÄÏû¨')) {
                    cssClass = 'warning';
                    icon = 'üìâ';
                    
                // Í∏∞Î≥∏ ÏïÑÏù¥ÏΩò (Ï≤´ Î≤àÏß∏ Ìï≠Î™©Ïù∏ Í≤ΩÏö∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨)
                } else if (numberedMatch && numberedMatch[1] === '1') {
                    cssClass = 'conclusion';
                    icon = 'üèÅ';
                }
                
                // ÌÖçÏä§Ìä∏ Í∞ïÏ°∞ Ï≤òÎ¶¨
                processedLine = processTextFormatting(processedLine);
                
                result += `
                    <li class="op-history-item ${cssClass}">
                        <span class="op-history-icon">${icon}</span>
                        <span class="op-history-text">${processedLine}</span>
                    </li>
                `;
            });
            
            result += `
                    </ul>
                </div>
            `;
            
            return result;
        }

        // ÌÖçÏä§Ìä∏ Ìè¨Îß∑ÌåÖ Ï≤òÎ¶¨ (Í∞ïÏ°∞, ÏàòÏπò Îì±) - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
        function processTextFormatting(text) {
            let processed = escapeHtml(text);
            
            // Í∞ïÏ°∞ ÌÖçÏä§Ìä∏ Ï≤òÎ¶¨ (ÎßàÌÅ¨Îã§Ïö¥ Ïä§ÌÉÄÏùº)
            processed = processed.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #2c3e50;">$1</strong>');
            processed = processed.replace(/\*(.+?)\*/g, '<em style="color: #6c757d; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">$1</em>');
            
            // ÏàòÏπòÏôÄ Îã®ÏúÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ (Îçî Ìè¨Í¥ÑÏ†Å)
            processed = processed.replace(/(\d+(?:\.\d+)?)\s*(‚ÑÉ|¬∞C|ÎèÑ|ÏãúÍ∞Ñ|Î∂Ñ|Ï¥à|%|Hz|rpm|kW|W|A|V|bar|Pa|L\/min|m¬≥\/h|dB)/gi, 
                '<strong style="color: #007bff; background: #e7f3ff; padding: 1px 4px; border-radius: 3px;">$1$2</strong>');
            
            // ÎÇ†ÏßúÏôÄ ÏãúÍ∞Ñ Í∞ïÏ°∞
            processed = processed.replace(/(\d{4}-\d{2}-\d{2}|\d{2}:\d{2}(?::\d{2})?)/g, 
                '<em style="color: #17a2b8; background: #d1ecf1; padding: 1px 4px; border-radius: 3px;">$1</em>');
            
            // ÏÉÅÌÉú ÌÇ§ÏõåÎìú Í∞ïÏ°∞ (Îçî Îã§ÏñëÌïú ÌÇ§ÏõåÎìú)
            processed = processed.replace(/(Ï†ïÏÉÅ|Ïù¥ÏÉÅ|Í≤ΩÍ≥†|Ïò§Î•ò|Î¨∏Ï†ú|ÏÑ±Í≥µ|Ïã§Ìå®|ÏôÑÎ£å|ÏßÑÌñâÏ§ë|ÎåÄÍ∏∞|Normal|Abnormal|Warning|Error|Success|Failed|Complete|Progress|Pending)/gi, 
                function(match) {
                    const lower = match.toLowerCase();
                    let color = '#2c3e50';
                    let bgColor = '#f8f9fa';
                    
                    if (lower.includes('Ï†ïÏÉÅ') || lower.includes('normal') || lower.includes('ÏÑ±Í≥µ') || lower.includes('success') || lower.includes('ÏôÑÎ£å') || lower.includes('complete')) {
                        color = '#28a745';
                        bgColor = '#d4edda';
                    } else if (lower.includes('Ïù¥ÏÉÅ') || lower.includes('abnormal') || lower.includes('Ïò§Î•ò') || lower.includes('error') || lower.includes('Ïã§Ìå®') || lower.includes('failed') || lower.includes('Î¨∏Ï†ú')) {
                        color = '#dc3545';
                        bgColor = '#f8d7da';
                    } else if (lower.includes('Í≤ΩÍ≥†') || lower.includes('warning') || lower.includes('Ï£ºÏùò')) {
                        color = '#fd7e14';
                        bgColor = '#fff3cd';
                    }
                    
                    return `<strong style="color: ${color}; background: ${bgColor}; padding: 2px 6px; border-radius: 4px; font-weight: 600;">${match}</strong>`;
                });
            
            // ÌçºÏÑºÌÖåÏù¥ÏßÄ Í∞ïÏ°∞
            processed = processed.replace(/(\d+(?:\.\d+)?%)/g, 
                '<strong style="color: #6f42c1; background: #e7e3ff; padding: 1px 4px; border-radius: 3px;">$1</strong>');
            
            // Î≤îÏúÑ ÌëúÌòÑ Í∞ïÏ°∞ (Ïòà: 20-25‚ÑÉ, 1-5Î∂Ñ)
            processed = processed.replace(/(\d+(?:\.\d+)?)\s*[-~]\s*(\d+(?:\.\d+)?)\s*([‚ÑÉ¬∞CFminÏ¥àÎ∂ÑÏãúÍ∞Ñ])/gi,
                '<strong style="color: #20c997; background: #d1f2eb; padding: 1px 4px; border-radius: 3px;">$1-$2$3</strong>');
            
            return processed;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Ìè¨Îß∑ÌåÖ Ï†ÅÏö© Ìï®Ïàò
        function applyOperationHistoryFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            
            const parent = textarea.parentNode;
            
            // Í∏∞Ï°¥ Ìè¨Îß∑Îêú ÏöîÏÜåÎì§ Ï†úÍ±∞
            const existingFormatted = parent.querySelector('.formatted-op-history');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existingFormatted) existingFormatted.remove();
            if (existingToggle) existingToggle.remove();
            
            // Ìè¨Îß∑Îêú div ÏÉùÏÑ±
            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatOperationHistorySummary(rawText);
            
            // ÌÜ†Í∏Ä Î≤ÑÌäº ÏÉùÏÑ±
            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ÏõêÎ≥∏';
            toggleButton.title = 'ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ Î≥¥Í∏∞/Ïà®Í∏∞Í∏∞';
            
            // textarea Ïà®Í∏∞Í≥† Ìè¨Îß∑Îêú divÏôÄ Î≤ÑÌäº Ï∂îÍ∞Ä
            textarea.style.display = 'none';
            parent.appendChild(formattedDiv);
            parent.appendChild(toggleButton);
            
            // ÌÜ†Í∏Ä Í∏∞Îä•
            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    // ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ ÌëúÏãú
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'Ìè¨Îß∑';
                    toggleButton.title = 'Ìè¨Îß∑Îêú Î≥¥Í∏∞Î°ú Ï†ÑÌôò';
                    showingFormatted = false;
                } else {
                    // Ìè¨Îß∑Îêú ÌÖçÏä§Ìä∏ ÌëúÏãú
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ÏõêÎ≥∏';
                    toggleButton.title = 'ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ Î≥¥Í∏∞Î°ú Ï†ÑÌôò';
                    showingFormatted = true;
                }
            }
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
            
            // Ìè¨Îß∑Îêú divÏóê Ìà¥ÌåÅ Ï∂îÍ∞Ä
            const formattedContent = formattedDiv.querySelector('.formatted-op-history');
            if (formattedContent) {
                formattedContent.title = 'ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÎ©¥ ÏõêÎ≥∏ ÌÖçÏä§Ìä∏Î•º Î≥º Ïàò ÏûàÏäµÎãàÎã§';
            }
        }

        // Ïä§Ìä∏Î¶¨Î∞ç ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
        async function generateContent() {
            const selectedId = document.getElementById('idSelect').value;
            const selectedLlm = document.getElementById('llmSelect').value;
            const selectedLanguage = document.getElementById('languageSelect').value;
            
            const diagnosisSummarizationTextarea = document.getElementById('diagnosisSummarization');
            const opHistorySummarizationTextarea = document.getElementById('opHistorySummarization');
            const diagnosisListsTextarea = document.getElementById('diagnosisLists');
            const operationHistoryTextarea = document.getElementById('operationHistory');
            
            if (!selectedId) {
                alert('IDÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
            const generateBtn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const statusMessage = document.getElementById('statusMessage');
            
            generateBtn.disabled = true;
            spinner.style.display = 'block';
            statusMessage.classList.remove('active'); // ÏÉÅÌÉú Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî
            
            // ÌÖçÏä§Ìä∏ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî Î∞è Í∏∞Ï°¥ Ìè¨Îß∑ Ï†úÍ±∞
            diagnosisSummarizationTextarea.value = '';
            opHistorySummarizationTextarea.value = '';
            document.getElementById('userGuide').value = ''; // User Guide Ï¥àÍ∏∞Ìôî
            
            // Í∏∞Ï°¥ Ìè¨Îß∑Îêú ÎîîÏä§ÌîåÎ†àÏù¥ Ï†úÍ±∞ - Îçî Ï≤†Ï†ÄÌïú Ï†ïÎ¶¨
            [diagnosisSummarizationTextarea, opHistorySummarizationTextarea, document.getElementById('userGuide')].forEach(textarea => {
                resetTextboxGroup(textarea);
            });

            try {
                // Î®ºÏ†Ä ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (JSON ÌòïÌÉúÎ°ú ÌëúÏãú)
                await loadOriginalData(selectedId, diagnosisListsTextarea, operationHistoryTextarea);
                
                // Î≥ëÎ†¨Î°ú Îëê Í∞úÏùò Ïä§Ìä∏Î¶¨Î∞ç ÏöîÏ≤≠ ÏãúÏûë
                const diagnosisPromise = streamDiagnosis(selectedId, selectedLlm, selectedLanguage, diagnosisSummarizationTextarea);
                const opHistoryPromise = streamOperationHistory(selectedId, selectedLlm, selectedLanguage, opHistorySummarizationTextarea);
                
                // Îëê Ïä§Ìä∏Î¶¨Î∞çÏù¥ Î™®Îëê ÏôÑÎ£åÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                await Promise.all([diagnosisPromise, opHistoryPromise]);
                
                // Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å ÌõÑ Ìè¨Îß∑ÌåÖ Ï†ÅÏö© (ÏßÑÎã®Í≥º Ïö¥ÏòÅ Ïù¥Î†• Î™®Îëê)
                setTimeout(() => {
                    applyDiagnosisFormatting(diagnosisSummarizationTextarea);
                    applyOperationHistoryFormatting(opHistorySummarizationTextarea);
                    // ÏßÑÎã® Í≤∞Í≥ºÍ∞Ä 'ÏûêÍ∞Ä Ï°∞Ïπò Í∞ÄÎä•'Ïù∏ Í≤ΩÏö∞ Í≥†Í∞ù Ï°∞Ïπò Í∞ÄÏù¥Îìú ÏÉùÏÑ± (ÌïúÍµ≠Ïñ¥Ïùº ÎïåÎßå)
                    tryGenerateActionsGuide();
                }, 500); // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Ìè¨Îß∑ÌåÖ Ï†ÅÏö©

            } catch (error) {
                console.error('Error during content generation:', error);
                diagnosisSummarizationTextarea.value = `Error: ${error.message}`;
                opHistorySummarizationTextarea.value = `Error: ${error.message}`;
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                generateBtn.disabled = false;
                spinner.style.display = 'none';
                statusMessage.classList.remove('active'); // ÏÉÅÌÉú Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
            }
        }

        function extractConclusionKo(text) {
            // Í≤∞Î°†: ÏûêÍ∞Ä Ï°∞Ïπò Í∞ÄÎä•/ÏàòÎ¶¨ ÌïÑÏöî/Ï†ïÏÉÅ Îì± Ìå®ÌÑ¥ ÌÉêÏßÄ
            const m = text.match(/Í≤∞Î°†\s*[:Ôºö]\s*([^\n]+)/);
            return m ? m[1].trim() : '';
        }

        function tryGenerateActionsGuide() {
            const lang = document.getElementById('languageSelect').value;
            if (lang !== 'ko') {
                console.log('[tryGenerateActionsGuide] Ïñ∏Ïñ¥Í∞Ä ÌïúÍµ≠Ïñ¥Í∞Ä ÏïÑÎãò:', lang);
                return;
            }
            
            const diagnosisText = document.getElementById('diagnosisSummarization').value || '';
            console.log('[tryGenerateActionsGuide] ÏßÑÎã® ÌÖçÏä§Ìä∏:', diagnosisText.substring(0, 200) + '...');
            
            const conclusion = extractConclusionKo(diagnosisText);
            console.log('[tryGenerateActionsGuide] Ï∂îÏ∂úÎêú Í≤∞Î°†:', conclusion);
            
            if (!conclusion || !/ÏûêÍ∞Ä\s*Ï°∞Ïπò\s*Í∞ÄÎä•|ÏûêÍ∞Ä\s*Ìï¥Í≤∞\s*Í∞ÄÎä•/.test(conclusion)) {
                console.log('[tryGenerateActionsGuide] Í≤∞Î°†Ïù¥ ÏûêÍ∞Ä Ï°∞Ïπò Í∞ÄÎä•Ïù¥ ÏïÑÎãò:', conclusion);
                return;
            }

            const selectedProduct = document.getElementById('productSelect').value; // airconditioner|refrigerator|washer
            const selectedId = document.getElementById('idSelect').value;
            
            console.log('[tryGenerateActionsGuide] ÏãúÏûë:', {
                lang,
                conclusion,
                selectedProduct,
                selectedId
            });

            // User Guide ÏÉùÏÑ± ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = '"User Guide"Î•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§.';
            statusMessage.classList.add('active');

            const userGuideTextarea = document.getElementById('userGuide');
            userGuideTextarea.value = '';

            // ÏßÑÎã® ÏöîÏïΩÏóêÏÑú Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Î∂ÄÎ∂Ñ Ï†úÍ±∞ (ÏõêÎ≥∏ ÎÇ¥Ïö©Îßå Ï†ÑÏÜ°)
            const cleanDiagnosisText = diagnosisText.split('üìä **Í∞ÄÎèÖÏÑ± Î∂ÑÏÑù Í≤∞Í≥º**')[0].trim();

            // ÏÑúÎ≤ÑÏóê Í∞ÄÏù¥Îìú ÏÉùÏÑ±ÏùÑ ÏöîÏ≤≠ (SSE streaming) - POSTÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÏßÑÎã® ÏöîÏïΩ Ï†ÑÏÜ°
            const url = `/api/stream/actions-guide/${selectedId}`;
            
            console.log('[tryGenerateActionsGuide] API ÏöîÏ≤≠:', {
                url,
                category: selectedProduct,
                language: lang,
                diagnosis_summary_length: cleanDiagnosisText.length
            });
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: selectedProduct,
                    language: lang,
                    diagnosis_summary: cleanDiagnosisText
                })
            }).then(resp => {
                if (!resp.ok) throw new Error(`HTTP error ${resp.status}`);
                console.log('[tryGenerateActionsGuide] ÏùëÎãµ Î∞õÏùå, Ïä§Ìä∏Î¶º ÏãúÏûë');
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                function readStream() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            console.log('[tryGenerateActionsGuide] Ïä§Ìä∏Î¶º ÏôÑÎ£å');
                            return;
                        }
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.error) {
                                        console.error('[tryGenerateActionsGuide] ÏÑúÎ≤Ñ ÏóêÎü¨:', data.error);
                                        statusMessage.classList.remove('active'); // ÏóêÎü¨ Ïãú ÏÉÅÌÉú Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                                        userGuideTextarea.value = `Ïò§Î•ò: ${data.error}`;
                                        return;
                                    }
                                    if (data.chunk) {
                                        userGuideTextarea.value += data.chunk;
                                        console.log('[tryGenerateActionsGuide] Ï≤≠ÌÅ¨ Î∞õÏùå:', data.chunk.substring(0, 50) + '...');
                                    }
                                    if (data.done) {
                                        console.log('[tryGenerateActionsGuide] Ïä§Ìä∏Î¶º ÏôÑÎ£å, ÌõÑÏ≤òÎ¶¨ ÏãúÏûë');
                                        // User Guide ÏÉùÏÑ± ÏôÑÎ£å - ÏÉÅÌÉú Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                                        statusMessage.classList.remove('active');
                                        // Ïä§Ìä∏Î¶º ÏôÑÎ£å ÌõÑ Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Ï≤òÎ¶¨ Î∞è Ìè¨Îß∑ÌåÖ
                                        setTimeout(() => {
                                            processReadabilityReport(userGuideTextarea);
                                            applyUserGuideFormatting(userGuideTextarea);
                                        }, 200);
                                        return;
                                    }
                                } catch (e) {
                                    console.warn('[tryGenerateActionsGuide] JSON ÌååÏã± Ïò§Î•ò:', e, line);
                                }
                            }
                        }
                        readStream();
                    }).catch((e) => {
                        console.error('[tryGenerateActionsGuide] Ïä§Ìä∏Î¶º ÏùΩÍ∏∞ Ïò§Î•ò:', e);
                        statusMessage.classList.remove('active'); // Ïä§Ìä∏Î¶º Ïò§Î•ò Ïãú ÏÉÅÌÉú Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                    });
                }
                readStream();
            }).catch((e) => {
                console.error('[tryGenerateActionsGuide] fetch Ïò§Î•ò:', e);
                statusMessage.classList.remove('active'); // fetch Ïò§Î•ò Ïãú ÏÉÅÌÉú Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                userGuideTextarea.value = `ÏöîÏ≤≠ Ïò§Î•ò: ${e.message}`;
            });
        }

        // User Guide Ìè¨Îß∑ÌåÖ
        function formatUserGuide(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            const lines = rawText.split('\n').filter(l => l.trim() !== '');
            const items = [];
            for (let i = 0; i < lines.length; i++) {
                const m = lines[i].match(/^(\d+)\.\s*(.+)$/);
                if (m) {
                    let content = m[2];
                    // Îã§Ïùå Ï§ÑÏù¥ Î≤àÌò∏Í∞Ä ÏïÑÎãàÎ©¥ Í∞ôÏùÄ Ìï≠Î™©ÏúºÎ°ú Ïù¥Ïñ¥Î∂ôÏûÑ
                    let j = i + 1;
                    while (j < lines.length && !/^(\d+)\./.test(lines[j])) {
                        content += ' ' + lines[j].trim();
                        j++;
                    }
                    i = j - 1;
                    // Ï∂úÏ≤ò URL Ï∂îÏ∂ú
                    let sourceHtml = '';
                    const urlMatch = content.match(/Ï∂úÏ≤ò\s*:\s*(https?:\/\/\S+)/i);
                    if (urlMatch) {
                        const url = urlMatch[1];
                        content = content.replace(urlMatch[0], '').trim();
                        sourceHtml = ` <span class="user-guide-source">(Ï∂úÏ≤ò: <a href="${url}" target="_blank">${url}</a>)</span>`;
                    }
                    // Í∞ïÏ°∞ Ï≤òÎ¶¨
                    content = processTextFormatting(content);
                    items.push(`<li class="user-guide-item">${content}${sourceHtml}</li>`);
                }
            }
            let html = `
                <div class="formatted-user-guide">
                    <h3 class="user-guide-title">
                        <span>Í≥†Í∞ù Ï°∞Ïπò Í∞ÄÏù¥Îìú</span>
                    </h3>
                    <ol class="user-guide-list">${items.join('')}</ol>
                </div>
            `;
            return html;
        }

        function applyUserGuideFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            const parent = textarea.parentNode;
            const existing = parent.querySelector('.formatted-user-guide');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existing) existing.remove();
            if (existingToggle) existingToggle.remove();

            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatUserGuide(rawText);

            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ÏõêÎ≥∏';
            toggleButton.title = 'ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ Î≥¥Í∏∞/Ïà®Í∏∞Í∏∞';
            
            // Í∞ÄÎèÖÏÑ± ÏÑπÏÖòÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            const readabilitySection = parent.querySelector('.readability-section');
            
            // textarea Ïà®Í∏∞Í≥† Ìè¨Îß∑Îêú divÏôÄ Î≤ÑÌäº Ï∂îÍ∞Ä
            textarea.style.display = 'none';
            
            // Í∞ÄÎèÖÏÑ± ÏÑπÏÖòÏù¥ ÏûàÏúºÎ©¥ Í∑∏ ÏïûÏóê Ï∂îÍ∞Ä, ÏóÜÏúºÎ©¥ Îß® Îí§Ïóê Ï∂îÍ∞Ä
            if (readabilitySection) {
                parent.insertBefore(formattedDiv, readabilitySection);
                parent.insertBefore(toggleButton, readabilitySection);
            } else {
                parent.appendChild(formattedDiv);
                parent.appendChild(toggleButton);
            }

            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'Ìè¨Îß∑';
                    toggleButton.title = 'Ìè¨Îß∑Îêú Î≥¥Í∏∞Î°ú Ï†ÑÌôò';
                    showingFormatted = false;
                } else {
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ÏõêÎ≥∏';
                    toggleButton.title = 'ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ Î≥¥Í∏∞Î°ú Ï†ÑÌôò';
                    showingFormatted = true;
                }
            }

            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
        }

        // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Í∏∞Ï°¥ Í∏∞Îä• Ïú†ÏßÄ)
        async function loadOriginalData(selectedId, diagnosisTextarea, operationTextarea) {
            try {
                // ÏßÑÎã® Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const diagnosisResponse = await fetch(`/api/diagnosis/${selectedId}`);
                if (diagnosisResponse.ok) {
                    const diagnosisData = await diagnosisResponse.json();
                    diagnosisTextarea.value = JSON.stringify(diagnosisData, null, 2);
                } else {
                    diagnosisTextarea.value = 'No diagnosis data available for this item.';
                }

                // Ïö¥ÏòÅ Ïù¥Î†• Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const operationResponse = await fetch(`/api/operation-history/${selectedId}`);
                if (operationResponse.ok) {
                    const contentType = operationResponse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        // ÏùºÎ∞ò JSON ÏùëÎãµ (ÏßßÏùÄ Îç∞Ïù¥ÌÑ∞)
                        const operationData = await operationResponse.json();
                        operationTextarea.value = JSON.stringify(operationData, null, 2);
                    } else {
                        // ÏûòÎ¶∞ ÌÖçÏä§Ìä∏ ÏùëÎãµ (Í∏¥ Îç∞Ïù¥ÌÑ∞)
                        const operationText = await operationResponse.text();
                        operationTextarea.value = operationText;
                    }
                } else {
                    operationTextarea.value = 'No operation history data available for this item.';
                }
            } catch (error) {
                diagnosisTextarea.value = `Error loading data: ${error.message}`;
                operationTextarea.value = `Error loading data: ${error.message}`;
            }
        }

        // ÏßÑÎã® Ïä§Ìä∏Î¶¨Î∞ç
        async function streamDiagnosis(itemId, llm, language, textarea) {
            return new Promise((resolve, reject) => {
                const url = `/api/stream/diagnosis/${itemId}?llm=${llm}&language=${language}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function readStream() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    // Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å ÌõÑ Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Ï≤òÎ¶¨
                                    processReadabilityReport(textarea);
                                    resolve();
                                    return;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            if (data.error) {
                                                textarea.value += `Error: ${data.error}`;
                                                reject(new Error(data.error));
                                                return;
                                            }
                                            if (data.chunk) {
                                                textarea.value += data.chunk;
                                            }
                                            if (data.done) {
                                                // Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å ÌõÑ Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Ï≤òÎ¶¨
                                                processReadabilityReport(textarea);
                                                resolve();
                                                return;
                                            }
                                        } catch (e) {
                                            // JSON ÌååÏã± Ïò§Î•ò Î¨¥Ïãú (Î∂àÏôÑÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞)
                                        }
                                    }
                                }
                                
                                readStream();
                            }).catch(reject);
                        }
                        
                        readStream();
                    })
                    .catch(reject);
            });
        }

        // Ïö¥ÏòÅ Ïù¥Î†• Ïä§Ìä∏Î¶¨Î∞ç
        async function streamOperationHistory(itemId, llm, language, textarea) {
            return new Promise((resolve, reject) => {
                const url = `/api/stream/operation-history/${itemId}?llm=${llm}&language=${language}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function readStream() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    // Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å ÌõÑ Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Ï≤òÎ¶¨
                                    processReadabilityReport(textarea);
                                    resolve();
                                    return;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            if (data.error) {
                                                textarea.value += `Error: ${data.error}`;
                                                reject(new Error(data.error));
                                                return;
                                            }
                                            if (data.chunk) {
                                                textarea.value += data.chunk;
                                            }
                                            if (data.done) {
                                                // Ïä§Ìä∏Î¶¨Î∞ç ÏôÑÎ£å ÌõÑ Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Ï≤òÎ¶¨
                                                processReadabilityReport(textarea);
                                                resolve();
                                                return;
                                            }
                                        } catch (e) {
                                            // JSON ÌååÏã± Ïò§Î•ò Î¨¥Ïãú (Î∂àÏôÑÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞)
                                        }
                                    }
                                }
                                
                                readStream();
                            }).catch(reject);
                        }
                        
                        readStream();
                    })
                    .catch(reject);
            });
        }

        // Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Ï≤òÎ¶¨ Ìï®Ïàò
        function processReadabilityReport(textarea) {
            const content = textarea.value;
            
            // Í∞ÄÎèÖÏÑ± Î∂ÑÏÑù Í≤∞Í≥º ÏÑπÏÖò Ï∞æÍ∏∞
            const reportStartIndex = content.indexOf('üìä **Í∞ÄÎèÖÏÑ± Î∂ÑÏÑù Í≤∞Í≥º**');
            if (reportStartIndex === -1) {
                return; // Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑúÍ∞Ä ÏóÜÏúºÎ©¥ Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
            }
            
            // ÏõêÎ≥∏ ÎÇ¥Ïö©Í≥º Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú Î∂ÑÎ¶¨
            const originalContent = content.substring(0, reportStartIndex).trim();
            const reportContent = content.substring(reportStartIndex).trim();
            
            // Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú ÌååÏã±
            const readabilityData = parseReadabilityReport(reportContent);
            
            // ÏõêÎ≥∏ ÎÇ¥Ïö©Îßå textareaÏóê Ïú†ÏßÄ
            textarea.value = originalContent;
            
            // Í∞ÄÎèÖÏÑ± ÏÑπÏÖò ÏÉùÏÑ± Î∞è ÌëúÏãú
            createReadabilitySection(textarea, readabilityData);
        }

        function parseReadabilityReport(reportText) {
            const data = {
                overall: 'unknown',
                metrics: {},
                technicalTerms: [],
                recommendations: []
            };
            
            try {
                // Ï¢ÖÌï© ÌèâÍ∞Ä ÌååÏã±
                const overallMatch = reportText.match(/üéØ \*\*Ï¢ÖÌï© ÌèâÍ∞Ä\*\*: (‚úÖ|‚ùå) (ÏñëÌò∏|Í∞úÏÑ† ÌïÑÏöî)/);
                if (overallMatch) {
                    data.overall = overallMatch[2] === 'ÏñëÌò∏' ? 'good' : 'poor';
                }
                
                // ÏÑ∏Î∂Ä Î∂ÑÏÑù ÌååÏã±
                const metricsSection = reportText.match(/üìã \*\*ÏÑ∏Î∂Ä Î∂ÑÏÑù\*\*:([\s\S]*?)(?=üîç|\üí°|$)/);
                if (metricsSection) {
                    const metricsText = metricsSection[1];
                    
                    // Í∞úÏ°∞Ïãù ÌòïÌÉú
                    const bulletMatch = metricsText.match(/‚Ä¢ Í∞úÏ°∞Ïãù ÌòïÌÉú: (‚úÖ|‚ùå) (\d+)Í∞ú Ìï≠Î™© \((ÏñëÌò∏|Í∞úÏÑ† ÌïÑÏöî)\)/);
                    if (bulletMatch) {
                        data.metrics.bullet = {
                            icon: bulletMatch[1],
                            count: parseInt(bulletMatch[2]),
                            status: bulletMatch[3]
                        };
                    }
                    
                    // Îã®Ïñ¥ Ïàò
                    const wordMatch = metricsText.match(/‚Ä¢ Îã®Ïñ¥ Ïàò: (‚úÖ|‚ùå) (\d+)Í∞ú Îã®Ïñ¥ \((ÏñëÌò∏|Í∞úÏÑ† ÌïÑÏöî)\)/);
                    if (wordMatch) {
                        data.metrics.words = {
                            icon: wordMatch[1],
                            count: parseInt(wordMatch[2]),
                            status: wordMatch[3]
                        };
                    }
                    
                    // Ïö©Ïñ¥ ÎÇúÏù¥ÎèÑ
                    const termsMatch = metricsText.match(/‚Ä¢ Ïö©Ïñ¥ ÎÇúÏù¥ÎèÑ: (‚úÖ|‚ùå) Ï†ÑÎ¨∏Ïö©Ïñ¥ ([\d.]+)% \((ÏñëÌò∏|Í∞úÏÑ† ÌïÑÏöî)\)/);
                    if (termsMatch) {
                        data.metrics.terms = {
                            icon: termsMatch[1],
                            ratio: parseFloat(termsMatch[2]),
                            status: termsMatch[3]
                        };
                    }
                    
                    // Í∞ÄÎèÖÏÑ± Ï†êÏàò
                    const scoreMatch = metricsText.match(/‚Ä¢ Í∞ÄÎèÖÏÑ± Ï†êÏàò: (‚úÖ|‚ùå) FK (\d+)Ï†ê \((ÏñëÌò∏|Í∞úÏÑ† ÌïÑÏöî)\)/);
                    if (scoreMatch) {
                        data.metrics.score = {
                            icon: scoreMatch[1],
                            value: parseInt(scoreMatch[2]),
                            status: scoreMatch[3]
                        };
                    }
                }
                
                // Î∞úÍ≤¨Îêú Ï†ÑÎ¨∏Ïö©Ïñ¥ ÌååÏã±
                const termsMatch = reportText.match(/üîç \*\*Î∞úÍ≤¨Îêú Ï†ÑÎ¨∏Ïö©Ïñ¥\*\*: (.+)/);
                if (termsMatch) {
                    data.technicalTerms = termsMatch[1].split(', ').map(term => term.trim());
                }
                
                // Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠ ÌååÏã±
                const recommendationsMatch = reportText.match(/üí° \*\*Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠\*\*:([\s\S]*?)$/);
                if (recommendationsMatch) {
                    const recommendationsText = recommendationsMatch[1];
                    const recommendations = recommendationsText.match(/‚Ä¢ ([^\n]+)/g);
                    if (recommendations) {
                        data.recommendations = recommendations.map(rec => rec.replace('‚Ä¢ ', '').trim());
                    }
                }
                
            } catch (error) {
                console.error('Í∞ÄÎèÖÏÑ± Î≥¥Í≥†ÏÑú ÌååÏã± Ïò§Î•ò:', error);
            }
            
            return data;
        }

        function createReadabilitySection(textarea, data) {
            const parent = textarea.parentNode; // textbox-group
            
            // Í∏∞Ï°¥ Í∞ÄÎèÖÏÑ± ÏÑπÏÖò Ï†úÍ±∞
            const existingSection = parent.querySelector('.readability-section');
            if (existingSection) {
                existingSection.remove();
            }
            
            // ÏÉà Í∞ÄÎèÖÏÑ± ÏÑπÏÖò ÏÉùÏÑ±
            const section = document.createElement('div');
            section.className = 'readability-section';
            // CSSÏóêÏÑú Ïù¥ÎØ∏ margin-top: 20pxÍ∞Ä Ï†ïÏùòÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú inline style Ï†úÍ±∞
            
            const overallClass = data.overall === 'good' ? 'good' : 'poor';
            const overallText = data.overall === 'good' ? 'ÏñëÌò∏' : 'Í∞úÏÑ† ÌïÑÏöî';
            const overallIcon = data.overall === 'good' ? '‚úÖ' : '‚ùå';
            
            let metricsHtml = '';
            if (data.metrics.bullet) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.bullet.icon}</span>
                        <span>Í∞úÏ°∞Ïãù ${data.metrics.bullet.count}Í∞ú Ìï≠Î™©</span>
                    </div>
                `;
            }
            if (data.metrics.words) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.words.icon}</span>
                        <span>${data.metrics.words.count}Í∞ú Îã®Ïñ¥</span>
                    </div>
                `;
            }
            if (data.metrics.terms) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.terms.icon}</span>
                        <span>Ï†ÑÎ¨∏Ïö©Ïñ¥ ${data.metrics.terms.ratio}%</span>
                    </div>
                `;
            }
            if (data.metrics.score) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.score.icon}</span>
                        <span>Í∞ÄÎèÖÏÑ± ${data.metrics.score.value}Ï†ê</span>
                    </div>
                `;
            }
            
            let technicalTermsHtml = '';
            if (data.technicalTerms.length > 0) {
                technicalTermsHtml = `
                    <div class="readability-terms">
                        <div class="readability-terms-title">üîç Î∞úÍ≤¨Îêú Ï†ÑÎ¨∏Ïö©Ïñ¥</div>
                        <div class="readability-terms-list">${data.technicalTerms.join(', ')}</div>
                    </div>
                `;
            }
            
            let recommendationsHtml = '';
            if (data.recommendations.length > 0) {
                const recommendationsList = data.recommendations.map(rec => `<li>${rec}</li>`).join('');
                recommendationsHtml = `
                    <div class="readability-recommendations">
                        <div class="readability-recommendations-title">
                            <span>üí°</span>
                            <span>Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠</span>
                        </div>
                        <ul>${recommendationsList}</ul>
                    </div>
                `;
            }
            
            section.innerHTML = `
                <div class="readability-header">
                    <div class="readability-title">
                        <span>üìä</span>
                        <span>Í∞ÄÎèÖÏÑ± Î∂ÑÏÑù Í≤∞Í≥º</span>
                    </div>
                    <button class="readability-toggle" onclick="toggleReadabilitySection(this)">Ï†ëÍ∏∞</button>
                </div>
                <div class="readability-content">
                    <div class="readability-overall ${overallClass}">
                        <span>${overallIcon}</span>
                        <span>Ï¢ÖÌï© ÌèâÍ∞Ä: ${overallText}</span>
                    </div>
                    <div class="readability-metrics">
                        ${metricsHtml}
                    </div>
                    ${technicalTermsHtml}
                    ${recommendationsHtml}
                </div>
            `;
            
            // textbox-groupÏùò Îß® ÎßàÏßÄÎßâÏóê Í∞ÄÎèÖÏÑ± ÏÑπÏÖò Ï∂îÍ∞Ä (textarea ÏïÑÎûò)
            parent.appendChild(section);
        }

        function toggleReadabilitySection(button) {
            const content = button.closest('.readability-section').querySelector('.readability-content');
            const isCollapsed = content.classList.contains('readability-collapsed');
            
            if (isCollapsed) {
                content.classList.remove('readability-collapsed');
                button.textContent = 'Ï†ëÍ∏∞';
            } else {
                content.classList.add('readability-collapsed');
                button.textContent = 'ÌéºÏπòÍ∏∞';
            }
        }

        // Textbox groupÏùÑ ÏõêÎûò ÏÉÅÌÉúÎ°ú ÏôÑÏ†ÑÌûà Î¶¨ÏÖãÌïòÎäî Ìï®Ïàò
        function resetTextboxGroup(textarea) {
            const parent = textarea.parentNode;
            
            // Î™®Îì† ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎêú ÏöîÏÜåÎì§ Ï†úÍ±∞
            const dynamicElements = parent.querySelectorAll('.formatted-op-history, .formatted-diagnosis, .formatted-user-guide, .format-toggle-btn, .readability-section');
            dynamicElements.forEach(element => element.remove());
            
            // textareaÎ•º Îã§Ïãú ÌëúÏãúÌïòÍ≥† Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
            textarea.style.display = 'block';
            textarea.style.position = '';
            textarea.style.margin = '';
            textarea.style.padding = '';
            
            // Î∂ÄÎ™® Ïª®ÌÖåÏù¥ÎÑàÏùò Ïä§ÌÉÄÏùºÎèÑ Ï¥àÍ∏∞Ìôî
            parent.style.height = '';
            parent.style.minHeight = '';
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú JSON Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        window.addEventListener('load', loadJsonData);
    </script>
</body>
</html>
