<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex-grow: 1;
        }

        .settings {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .setting-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .setting-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .control-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        select:hover {
            border-color: #007bff;
        }

        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .generate-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 20px;
        }

        .generate-btn:hover {
            background-color: #0056b3;
        }

        .generate-btn:active {
            transform: translateY(1px);
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 20px;
        }

        .top-textboxes {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .bottom-textboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .textbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .textbox-label {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        textarea {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background-color: white;
        }

        .readonly {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-container {
            display: flex;
            align-items: center;
        }

        /* Formatted operation history styles */
        .formatted-op-history {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .formatted-op-history:hover {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background-color: white;
        }

        .op-history-title {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .op-history-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .op-history-item {
            margin: 12px 0;
            padding: 12px 15px;
            border-radius: 6px;
            position: relative;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .op-history-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .op-history-item.conclusion {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .op-history-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .op-history-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .op-history-item.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .op-history-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .op-history-text {
            display: inline;
        }

        .op-history-text strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .op-history-text em {
            color: #6c757d;
            font-style: normal;
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .format-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .format-toggle-btn:hover {
            opacity: 1;
        }

        /* Formatted diagnosis styles */
        .formatted-diagnosis {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .formatted-diagnosis:hover {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: white;
        }

        .diagnosis-title {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 2px solid #28a745;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diagnosis-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .diagnosis-item {
            margin: 12px 0;
            padding: 12px 15px;
            border-radius: 6px;
            position: relative;
            border-left: 4px solid #28a745;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .diagnosis-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .diagnosis-item.normal {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .diagnosis-item.abnormal {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .diagnosis-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .diagnosis-item.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .diagnosis-item.recommendation {
            background: #e2e3ff;
            border-left-color: #6f42c1;
        }

        .diagnosis-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .diagnosis-text {
            display: inline;
        }

        .diagnosis-text strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .diagnosis-text em {
            color: #6c757d;
            font-style: normal;
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">HRM AI Agent</h1>
            <div class="settings">
                <div class="setting-group">
                    <label class="setting-label">LLM:</label>
                    <select id="llmSelect">
                        <option value="aws">AWS</option>
                        <option value="openai">OpenAI</option>
                        <option value="gauss">Gauss</option>
                        <option value="gausso">Gausso</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Language:</label>
                    <select id="languageSelect">
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">Product:</label>
                <select id="productSelect">
                    <option value="airconditioner">Airconditioner</option>
                    <option value="refrigerator">Refrigerator</option>
                    <option value="washer">Washer</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">ID:</label>
                <select id="idSelect">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="button-container">
                <button class="generate-btn" id="generateBtn" onclick="generateContent()">Generation</button>
                <div class="spinner" id="loadingSpinner"></div>
            </div>
        </div>

        <div class="content-area">
            <div class="top-textboxes">
                <div class="textbox-group">
                    <label class="textbox-label">Diagnosis Summarization</label>
                    <textarea id="diagnosisSummarization" placeholder="AIê°€ ìƒì„±í•œ ì§„ë‹¨ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">Op. History Summarization</label>
                    <textarea id="opHistorySummarization" placeholder="AIê°€ ìƒì„±í•œ ìš´ì˜ ì´ë ¥ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">User Guide</label>
                    <textarea id="userGuide" placeholder="AIê°€ ìƒì„±í•œ ì‚¬ìš©ì ê°€ì´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
            <div class="bottom-textboxes">
                <div class="textbox-group">
                    <label class="textbox-label">Diagnosis Lists</label>
                    <textarea id="diagnosisLists" class="readonly" readonly placeholder="ì„ íƒëœ ì œí’ˆì˜ ì§„ë‹¨ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">Operation History</label>
                    <textarea id="operationHistory" class="readonly" readonly placeholder="ì„ íƒëœ ì œí’ˆì˜ ìš´ì˜ ì´ë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let jsonData = [];

        // JSON ë°ì´í„° ë¡œë“œ
        async function loadJsonData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                jsonData = await response.json();
                console.log('JSON data loaded:', jsonData.length, 'items');
                updateIdOptions();
            } catch (error) {
                console.error('Error loading JSON data:', error);
                document.getElementById('idSelect').innerHTML = '<option value="">Error loading data</option>';
            }
        }

        // ID ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateIdOptions() {
            const productSelect = document.getElementById('productSelect');
            const idSelect = document.getElementById('idSelect');
            const selectedProduct = productSelect.value;
            
            // ì„ íƒëœ ì œí’ˆì— í•´ë‹¹í•˜ëŠ” IDë“¤ í•„í„°ë§
            const filteredData = jsonData.filter(item => {
                if (selectedProduct === 'airconditioner') {
                    return item.id.startsWith('airconditioner_');
                } else if (selectedProduct === 'refrigerator') {
                    return item.id.startsWith('refrigerator_');
                } else if (selectedProduct === 'washer') {
                    return item.id.startsWith('washer_');
                }
                return false;
            });

            // ID ì˜µì…˜ ìƒì„±
            idSelect.innerHTML = '';
            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.id;
                    idSelect.appendChild(option);
                });
            } else {
                // í•´ë‹¹ ì œí’ˆ íƒ€ì…ì˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                for (let i = 1; i <= 25; i++) {
                    const option = document.createElement('option');
                    const idNumber = String(i).padStart(3, '0');
                    option.value = `${selectedProduct}_${idNumber}`;
                    option.textContent = `${selectedProduct}_${idNumber}`;
                    idSelect.appendChild(option);
                }
            }
        }

        // ì œí’ˆ ë³€ê²½ ì‹œ ID ì˜µì…˜ ì—…ë°ì´íŠ¸
        document.getElementById('productSelect').addEventListener('change', updateIdOptions);

        // ì§„ë‹¨ ìš”ì•½ í›„ì²˜ë¦¬ í•¨ìˆ˜
        function formatDiagnosisSummary(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            
            let lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            // ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì–¸ì–´ í‚¤ì›Œë“œ ì œê±° (ìš´ì˜ ì´ë ¥ê³¼ ë™ì¼í•œ ë¡œì§)
            if (lines.length > 0) {
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // ì–¸ì–´ í‚¤ì›Œë“œ íŒ¨í„´ë“¤
                    const languagePatterns = [
                        /^í•œêµ­ì–´[:ï¼š\s]*(.*)$/gi,
                        /^ì˜ì–´[:ï¼š\s]*(.*)$/gi,
                        /^English[:ï¼š\s]*(.*)$/gi,
                        /^Korean[:ï¼š\s]*(.*)$/gi,
                        /^í•œê¸€[:ï¼š\s]*(.*)$/gi,
                        /^korean[:ï¼š\s]*(.*)$/gi,
                        /^english[:ï¼š\s]*(.*)$/gi,
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]+(.+)$/gi,
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]*$/gi
                    ];
                    
                    let cleanedLine = line;
                    let wasLanguageLine = false;
                    
                    for (const pattern of languagePatterns) {
                        const match = cleanedLine.match(pattern);
                        if (match) {
                            if (match[1] && match[1].trim()) {
                                cleanedLine = match[1].trim();
                            } else if (match[2] && match[2].trim()) {
                                cleanedLine = match[2].trim();
                            } else {
                                wasLanguageLine = true;
                                break;
                            }
                            break;
                        }
                    }
                    
                    if (!wasLanguageLine && cleanedLine && cleanedLine.length > 0) {
                        processedLines.push(cleanedLine);
                    }
                }
                
                lines = processedLines;
            }
            
            let result = `
                <div class="formatted-diagnosis">
                    <h3 class="diagnosis-title">
                        <span>ğŸ©º</span>
                        <span>ì§„ë‹¨ ë¶„ì„ ê²°ê³¼</span>
                        <span style="margin-left: auto; font-size: 0.8em; color: #6c757d;">ğŸ”¬</span>
                    </h3>
                    <ul class="diagnosis-list">
            `;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') return;
                
                let cssClass = '';
                let icon = 'ğŸ”¹';
                let processedLine = trimmedLine;
                
                // ë²ˆí˜¸ê°€ ìˆëŠ” ì¤„ ì²˜ë¦¬ (1., 2., 3. ë“±)
                const numberedMatch = processedLine.match(/^(\d+)\.\s*(.+)/);
                let isNumbered = false;
                let numberText = '';
                
                if (numberedMatch) {
                    numberText = numberedMatch[1];
                    processedLine = numberedMatch[2];
                    isNumbered = true;
                    
                    // ë²ˆí˜¸ê°€ ìˆëŠ” í•­ëª©ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼
                    cssClass = 'info';
                    icon = ''; // ë²ˆí˜¸ê°€ ìˆì„ ë•ŒëŠ” ì•„ì´ì½˜ ì‚¬ìš© ì•ˆ í•¨
                }
                
                // í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ë¥˜ ë° ì•„ì´ì½˜ ì„¤ì •
                const lowerLine = processedLine.toLowerCase();
                
                // ë²ˆí˜¸ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ í‚¤ì›Œë“œ ê¸°ë°˜ ì•„ì´ì½˜ ì„¤ì •
                if (!isNumbered) {
                    // ì •ìƒ/ì •ìƒ ë™ì‘
                    if (lowerLine.includes('ì •ìƒ') || lowerLine.includes('normal') || 
                        lowerLine.includes('ì–‘í˜¸') || lowerLine.includes('good') ||
                        lowerLine.includes('ë¬¸ì œì—†ìŒ') || lowerLine.includes('ì •ìƒ ë™ì‘')) {
                        cssClass = 'normal';
                        icon = 'âœ…';
                        
                    // ì´ìƒ/ì˜¤ë¥˜/ë¬¸ì œ
                    } else if (lowerLine.includes('ì´ìƒ') || lowerLine.includes('abnormal') || 
                              lowerLine.includes('ë¬¸ì œ') || lowerLine.includes('ì˜¤ë¥˜') || 
                              lowerLine.includes('error') || lowerLine.includes('fault') ||
                              lowerLine.includes('ê³ ì¥') || lowerLine.includes('ë¶ˆëŸ‰')) {
                        cssClass = 'abnormal';
                        icon = 'ğŸš¨';
                        
                    // ê¶Œì¥ì‚¬í•­/ì¡°ì¹˜ì‚¬í•­
                    } else if (lowerLine.includes('ê¶Œì¥') || lowerLine.includes('recommend') || 
                              lowerLine.includes('ì¡°ì¹˜') || lowerLine.includes('action') ||
                              lowerLine.includes('ê°œì„ ') || lowerLine.includes('improve') ||
                              lowerLine.includes('êµì²´') || lowerLine.includes('ì²­ì†Œ') ||
                              lowerLine.includes('ì ê²€') || lowerLine.includes('í™•ì¸')) {
                        cssClass = 'recommendation';
                        icon = 'ğŸ’¡';
                        
                    // ì£¼ì˜/ê²½ê³ 
                    } else if (lowerLine.includes('ì£¼ì˜') || lowerLine.includes('warning') || 
                              lowerLine.includes('ê²½ê³ ') || lowerLine.includes('alert') ||
                              lowerLine.includes('ìœ„í—˜') || lowerLine.includes('risk')) {
                        cssClass = 'warning';
                        icon = 'âš ï¸';
                        
                    // í•„í„° ê´€ë ¨
                    } else if (lowerLine.includes('í•„í„°') || lowerLine.includes('filter') ||
                              lowerLine.includes('ë¨¼ì§€') || lowerLine.includes('dust') ||
                              lowerLine.includes('ì²­ì†Œ') || lowerLine.includes('clean')) {
                        cssClass = 'recommendation';
                        icon = 'ğŸ§½';
                        
                    // ì˜¨ë„ ê´€ë ¨
                    } else if (lowerLine.includes('ì˜¨ë„') || lowerLine.includes('temperature') ||
                              lowerLine.includes('â„ƒ') || lowerLine.includes('Â°c') ||
                              lowerLine.includes('ëƒ‰ê°') || lowerLine.includes('ëƒ‰ë°©')) {
                        cssClass = 'info';
                        icon = 'ğŸŒ¡ï¸';
                        
                    // ì†ŒìŒ ê´€ë ¨
                    } else if (lowerLine.includes('ì†ŒìŒ') || lowerLine.includes('noise') ||
                              lowerLine.includes('ì†Œë¦¬') || lowerLine.includes('sound')) {
                        cssClass = 'warning';
                        icon = 'ğŸ”Š';
                        
                    // ë°ì´í„°/ì •ë³´ ê´€ë ¨
                    } else if (lowerLine.includes('ë°ì´í„°') || lowerLine.includes('ì •ë³´') || 
                              lowerLine.includes('ì¸¡ì •') || lowerLine.includes('ê¸°ë¡') ||
                              lowerLine.includes('data') || lowerLine.includes('info') ||
                              lowerLine.includes('ë¶€ì¡±') || lowerLine.includes('insufficient')) {
                        cssClass = 'info';
                        icon = 'ğŸ“Š';
                    }
                } else {
                    // ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš° í‚¤ì›Œë“œì— ë”°ë¼ ë°°ê²½ìƒ‰ë§Œ ë³€ê²½
                    if (lowerLine.includes('ì •ìƒ') || lowerLine.includes('normal') || 
                        lowerLine.includes('ì–‘í˜¸') || lowerLine.includes('good') ||
                        lowerLine.includes('ë¬¸ì œì—†ìŒ') || lowerLine.includes('ì •ìƒ ë™ì‘')) {
                        cssClass = 'normal';
                    } else if (lowerLine.includes('ì´ìƒ') || lowerLine.includes('abnormal') || 
                              lowerLine.includes('ë¬¸ì œ') || lowerLine.includes('ì˜¤ë¥˜') || 
                              lowerLine.includes('error') || lowerLine.includes('fault') ||
                              lowerLine.includes('ê³ ì¥') || lowerLine.includes('ë¶ˆëŸ‰')) {
                        cssClass = 'abnormal';
                    } else if (lowerLine.includes('ê¶Œì¥') || lowerLine.includes('recommend') || 
                              lowerLine.includes('ì¡°ì¹˜') || lowerLine.includes('action') ||
                              lowerLine.includes('ê°œì„ ') || lowerLine.includes('improve') ||
                              lowerLine.includes('êµì²´') || lowerLine.includes('ì²­ì†Œ') ||
                              lowerLine.includes('ì ê²€') || lowerLine.includes('í™•ì¸')) {
                        cssClass = 'recommendation';
                    } else if (lowerLine.includes('ì£¼ì˜') || lowerLine.includes('warning') || 
                              lowerLine.includes('ê²½ê³ ') || lowerLine.includes('alert') ||
                              lowerLine.includes('ìœ„í—˜') || lowerLine.includes('risk')) {
                        cssClass = 'warning';
                    }
                }
                
                // í…ìŠ¤íŠ¸ ê°•ì¡° ì²˜ë¦¬
                processedLine = processTextFormatting(processedLine);
                
                if (isNumbered) {
                    // ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš°: ìˆ«ìë¥¼ ê°•ì¡°í•˜ê³  í…ìŠ¤íŠ¸ë„ ê°•ì¡°
                    result += `
                        <li class="diagnosis-item ${cssClass}">
                            <span class="diagnosis-text">
                                <strong style="color: #2c3e50; font-size: 1.1em;">${numberText}.</strong> 
                                <strong>${processedLine}</strong>
                            </span>
                        </li>
                    `;
                } else {
                    // ë²ˆí˜¸ê°€ ì—†ëŠ” ê²½ìš°: ê¸°ì¡´ ë°©ì‹ (ì•„ì´ì½˜ ì‚¬ìš©)
                    result += `
                        <li class="diagnosis-item ${cssClass}">
                            <span class="diagnosis-icon">${icon}</span>
                            <span class="diagnosis-text">${processedLine}</span>
                        </li>
                    `;
                }
            });
            
            result += `
                    </ul>
                </div>
            `;
            
            return result;
        }

        // ì§„ë‹¨ í¬ë§·íŒ… ì ìš© í•¨ìˆ˜
        function applyDiagnosisFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            
            const parent = textarea.parentNode;
            
            // ê¸°ì¡´ í¬ë§·ëœ ìš”ì†Œë“¤ ì œê±°
            const existingFormatted = parent.querySelector('.formatted-diagnosis');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existingFormatted) existingFormatted.remove();
            if (existingToggle) existingToggle.remove();
            
            // í¬ë§·ëœ div ìƒì„±
            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatDiagnosisSummary(rawText);
            
            // í† ê¸€ ë²„íŠ¼ ìƒì„±
            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ì›ë³¸';
            toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°';
            
            // textarea ìˆ¨ê¸°ê³  í¬ë§·ëœ divì™€ ë²„íŠ¼ ì¶”ê°€
            textarea.style.display = 'none';
            parent.appendChild(formattedDiv);
            parent.appendChild(toggleButton);
            
            // í† ê¸€ ê¸°ëŠ¥
            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'í¬ë§·';
                    toggleButton.title = 'í¬ë§·ëœ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = false;
                } else {
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ì›ë³¸';
                    toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = true;
                }
            }
            
            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
            
            const formattedContent = formattedDiv.querySelector('.formatted-diagnosis');
            if (formattedContent) {
                formattedContent.title = 'ë”ë¸”í´ë¦­í•˜ë©´ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            }
        }

        // ìš´ì˜ ì´ë ¥ ìš”ì•½ í›„ì²˜ë¦¬ í•¨ìˆ˜
        function formatOperationHistorySummary(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            
            // HTML ì—”í‹°í‹° ì´ìŠ¤ì¼€ì´í”„
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            let lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            // ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì–¸ì–´ í‚¤ì›Œë“œ ì œê±° (ê°•í™”ëœ ë²„ì „)
            if (lines.length > 0) {
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // ì–¸ì–´ í‚¤ì›Œë“œ íŒ¨í„´ë“¤ (ë” í¬ê´„ì )
                    const languagePatterns = [
                        /^í•œêµ­ì–´[:ï¼š\s]*(.*)$/gi,
                        /^ì˜ì–´[:ï¼š\s]*(.*)$/gi,
                        /^English[:ï¼š\s]*(.*)$/gi,
                        /^Korean[:ï¼š\s]*(.*)$/gi,
                        /^í•œê¸€[:ï¼š\s]*(.*)$/gi,
                        /^korean[:ï¼š\s]*(.*)$/gi,
                        /^english[:ï¼š\s]*(.*)$/gi,
                        // ì¤„ ì‹œì‘ ë¶€ë¶„ì˜ ì–¸ì–´ í‚¤ì›Œë“œ
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]+(.+)$/gi,
                        // ì¤„ ì „ì²´ê°€ ì–¸ì–´ í‚¤ì›Œë“œì¸ ê²½ìš°
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]*$/gi
                    ];
                    
                    let cleanedLine = line;
                    let wasLanguageLine = false;
                    
                    // ê° íŒ¨í„´ì„ í™•ì¸í•˜ì—¬ ì–¸ì–´ í‚¤ì›Œë“œ ì œê±°
                    for (const pattern of languagePatterns) {
                        const match = cleanedLine.match(pattern);
                        if (match) {
                            if (match[1] && match[1].trim()) {
                                // ì–¸ì–´ í‚¤ì›Œë“œ ë’¤ì— ë‚´ìš©ì´ ìˆìœ¼ë©´ ê·¸ ë‚´ìš©ë§Œ ìœ ì§€
                                cleanedLine = match[1].trim();
                            } else if (match[2] && match[2].trim()) {
                                // ë‘ ë²ˆì§¸ ìº¡ì²˜ ê·¸ë£¹ì— ë‚´ìš©ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                                cleanedLine = match[2].trim();
                            } else {
                                // ì–¸ì–´ í‚¤ì›Œë“œë§Œ ìˆê³  ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì´ ì¤„ì„ ê±´ë„ˆëœ€
                                wasLanguageLine = true;
                                break;
                            }
                            break;
                        }
                    }
                    
                    // ìœ íš¨í•œ ë‚´ìš©ì´ ìˆëŠ” ì¤„ë§Œ ì¶”ê°€
                    if (!wasLanguageLine && cleanedLine && cleanedLine.length > 0) {
                        processedLines.push(cleanedLine);
                    }
                }
                
                lines = processedLines;
            }
            
            let result = `
                <div class="formatted-op-history">
                    <h3 class="op-history-title">
                        <span>ğŸ”</span>
                        <span>ìš´ì˜ ì´ë ¥ ë¶„ì„ ê²°ê³¼</span>
                        <span style="margin-left: auto; font-size: 0.8em; color: #6c757d;">ğŸ“ˆ</span>
                    </h3>
                    <ul class="op-history-list">
            `;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') return;
                
                let cssClass = '';
                let icon = 'â–¶';
                let processedLine = trimmedLine;
                
                // ë²ˆí˜¸ê°€ ìˆëŠ” ì¤„ ì²˜ë¦¬ (1., 2., 3. ë“±)
                const numberedMatch = processedLine.match(/^(\d+)\.\s*(.+)/);
                if (numberedMatch) {
                    processedLine = numberedMatch[2];
                    
                    // ì²« ë²ˆì§¸ í•­ëª©ì€ ë³´í†µ ê²°ë¡ 
                    if (numberedMatch[1] === '1') {
                        cssClass = 'conclusion';
                        icon = 'âœ“';
                    }
                }
                
                // í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ë¥˜ ë° ì•„ì´ì½˜ ì„¤ì • (ê°œì„ ëœ ë²„ì „)
                const lowerLine = processedLine.toLowerCase();
                
                // ì •ìƒ/ì„±ê³µ ìƒíƒœ
                if (lowerLine.includes('ì •ìƒ') || lowerLine.includes('normal') || 
                    lowerLine.includes('ì„±ê³µ') || lowerLine.includes('ì™„ë£Œ') || 
                    lowerLine.includes('ì–‘í˜¸') || lowerLine.includes('success')) {
                    cssClass = 'conclusion';
                    icon = 'âœ…';
                    
                // ì˜¤ë¥˜/ë¬¸ì œ ìƒíƒœ  
                } else if (lowerLine.includes('ì´ìƒ') || lowerLine.includes('abnormal') || 
                          lowerLine.includes('ë¬¸ì œ') || lowerLine.includes('ì˜¤ë¥˜') || 
                          lowerLine.includes('error') || lowerLine.includes('fault') ||
                          lowerLine.includes('ì‹¤íŒ¨') || lowerLine.includes('ê³ ì¥')) {
                    cssClass = 'error';
                    icon = 'ğŸš¨';
                    
                // ê²½ê³ /ì£¼ì˜ ìƒíƒœ
                } else if (lowerLine.includes('ì£¼ì˜') || lowerLine.includes('warning') || 
                          lowerLine.includes('í™•ì¸') || lowerLine.includes('ì ê²€') ||
                          lowerLine.includes('ê¶Œì¥') || lowerLine.includes('recommend') ||
                          lowerLine.includes('ì•Œë¦¼') || lowerLine.includes('notice')) {
                    cssClass = 'warning';
                    icon = 'âš ï¸';
                    
                // ì˜¨ë„ ê´€ë ¨
                } else if (lowerLine.includes('ì˜¨ë„') || lowerLine.includes('temperature') ||
                          lowerLine.includes('â„ƒ') || lowerLine.includes('Â°c') ||
                          lowerLine.includes('ì—´') || lowerLine.includes('ëƒ‰ê°')) {
                    cssClass = 'info';
                    icon = 'ğŸŒ¡ï¸';
                    
                // ì „ë ¥/ì—ë„ˆì§€ ê´€ë ¨
                } else if (lowerLine.includes('ì „ë ¥') || lowerLine.includes('power') ||
                          lowerLine.includes('ì—ë„ˆì§€') || lowerLine.includes('energy') ||
                          lowerLine.includes('kw') || lowerLine.includes('ì „ê¸°')) {
                    cssClass = 'info';
                    icon = 'âš¡';
                    
                // ì‹œê°„/ì£¼ê¸° ê´€ë ¨
                } else if (lowerLine.includes('ì‹œê°„') || lowerLine.includes('time') ||
                          lowerLine.includes('ì£¼ê¸°') || lowerLine.includes('cycle') ||
                          lowerLine.includes('ë¶„') || lowerLine.includes('ì´ˆ')) {
                    cssClass = 'info';
                    icon = 'â°';
                    
                // ë°ì´í„°/ì •ë³´ ê´€ë ¨
                } else if (lowerLine.includes('ë°ì´í„°') || lowerLine.includes('ì •ë³´') || 
                          lowerLine.includes('ì¸¡ì •') || lowerLine.includes('ê¸°ë¡') ||
                          lowerLine.includes('data') || lowerLine.includes('info') ||
                          lowerLine.includes('ë¡œê·¸') || lowerLine.includes('ê¸°ë¡')) {
                    cssClass = 'info';
                    icon = 'ğŸ“Š';
                    
                // ë¶€ì¡±/ì—†ìŒ ìƒíƒœ
                } else if (lowerLine.includes('ë¶€ì¡±') || lowerLine.includes('ì—†ìŒ') ||
                          lowerLine.includes('insufficient') || lowerLine.includes('lack') ||
                          lowerLine.includes('missing') || lowerLine.includes('ë¶€ì¬')) {
                    cssClass = 'warning';
                    icon = 'ğŸ“‰';
                    
                // ê¸°ë³¸ ì•„ì´ì½˜ (ì²« ë²ˆì§¸ í•­ëª©ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬)
                } else if (numberedMatch && numberedMatch[1] === '1') {
                    cssClass = 'conclusion';
                    icon = 'ğŸ';
                }
                
                // í…ìŠ¤íŠ¸ ê°•ì¡° ì²˜ë¦¬
                processedLine = processTextFormatting(processedLine);
                
                result += `
                    <li class="op-history-item ${cssClass}">
                        <span class="op-history-icon">${icon}</span>
                        <span class="op-history-text">${processedLine}</span>
                    </li>
                `;
            });
            
            result += `
                    </ul>
                </div>
            `;
            
            return result;
        }

        // í…ìŠ¤íŠ¸ í¬ë§·íŒ… ì²˜ë¦¬ (ê°•ì¡°, ìˆ˜ì¹˜ ë“±) - ê°œì„ ëœ ë²„ì „
        function processTextFormatting(text) {
            let processed = escapeHtml(text);
            
            // ê°•ì¡° í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼)
            processed = processed.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #2c3e50;">$1</strong>');
            processed = processed.replace(/\*(.+?)\*/g, '<em style="color: #6c757d; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">$1</em>');
            
            // ìˆ˜ì¹˜ì™€ ë‹¨ìœ„ í•˜ì´ë¼ì´íŠ¸ (ë” í¬ê´„ì )
            processed = processed.replace(/(\d+(?:\.\d+)?)\s*(â„ƒ|Â°C|ë„|ì‹œê°„|ë¶„|ì´ˆ|%|Hz|rpm|kW|W|A|V|bar|Pa|L\/min|mÂ³\/h|dB)/gi, 
                '<strong style="color: #007bff; background: #e7f3ff; padding: 1px 4px; border-radius: 3px;">$1$2</strong>');
            
            // ë‚ ì§œì™€ ì‹œê°„ ê°•ì¡°
            processed = processed.replace(/(\d{4}-\d{2}-\d{2}|\d{2}:\d{2}(?::\d{2})?)/g, 
                '<em style="color: #17a2b8; background: #d1ecf1; padding: 1px 4px; border-radius: 3px;">$1</em>');
            
            // ìƒíƒœ í‚¤ì›Œë“œ ê°•ì¡° (ë” ë‹¤ì–‘í•œ í‚¤ì›Œë“œ)
            processed = processed.replace(/(ì •ìƒ|ì´ìƒ|ê²½ê³ |ì˜¤ë¥˜|ë¬¸ì œ|ì„±ê³µ|ì‹¤íŒ¨|ì™„ë£Œ|ì§„í–‰ì¤‘|ëŒ€ê¸°|Normal|Abnormal|Warning|Error|Success|Failed|Complete|Progress|Pending)/gi, 
                function(match) {
                    const lower = match.toLowerCase();
                    let color = '#2c3e50';
                    let bgColor = '#f8f9fa';
                    
                    if (lower.includes('ì •ìƒ') || lower.includes('normal') || lower.includes('ì„±ê³µ') || lower.includes('success') || lower.includes('ì™„ë£Œ') || lower.includes('complete')) {
                        color = '#28a745';
                        bgColor = '#d4edda';
                    } else if (lower.includes('ì´ìƒ') || lower.includes('abnormal') || lower.includes('ì˜¤ë¥˜') || lower.includes('error') || lower.includes('ì‹¤íŒ¨') || lower.includes('failed') || lower.includes('ë¬¸ì œ')) {
                        color = '#dc3545';
                        bgColor = '#f8d7da';
                    } else if (lower.includes('ê²½ê³ ') || lower.includes('warning') || lower.includes('ì£¼ì˜')) {
                        color = '#fd7e14';
                        bgColor = '#fff3cd';
                    }
                    
                    return `<strong style="color: ${color}; background: ${bgColor}; padding: 2px 6px; border-radius: 4px; font-weight: 600;">${match}</strong>`;
                });
            
            // í¼ì„¼í…Œì´ì§€ ê°•ì¡°
            processed = processed.replace(/(\d+(?:\.\d+)?%)/g, 
                '<strong style="color: #6f42c1; background: #e7e3ff; padding: 1px 4px; border-radius: 3px;">$1</strong>');
            
            // ë²”ìœ„ í‘œí˜„ ê°•ì¡° (ì˜ˆ: 20-25â„ƒ, 1-5ë¶„)
            processed = processed.replace(/(\d+(?:\.\d+)?)\s*[-~]\s*(\d+(?:\.\d+)?)\s*([â„ƒÂ°CFminì´ˆë¶„ì‹œê°„])/gi,
                '<strong style="color: #20c997; background: #d1f2eb; padding: 1px 4px; border-radius: 3px;">$1-$2$3</strong>');
            
            return processed;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í¬ë§·íŒ… ì ìš© í•¨ìˆ˜
        function applyOperationHistoryFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            
            const parent = textarea.parentNode;
            
            // ê¸°ì¡´ í¬ë§·ëœ ìš”ì†Œë“¤ ì œê±°
            const existingFormatted = parent.querySelector('.formatted-op-history');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existingFormatted) existingFormatted.remove();
            if (existingToggle) existingToggle.remove();
            
            // í¬ë§·ëœ div ìƒì„±
            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatOperationHistorySummary(rawText);
            
            // í† ê¸€ ë²„íŠ¼ ìƒì„±
            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ì›ë³¸';
            toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°';
            
            // textarea ìˆ¨ê¸°ê³  í¬ë§·ëœ divì™€ ë²„íŠ¼ ì¶”ê°€
            textarea.style.display = 'none';
            parent.appendChild(formattedDiv);
            parent.appendChild(toggleButton);
            
            // í† ê¸€ ê¸°ëŠ¥
            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    // ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'í¬ë§·';
                    toggleButton.title = 'í¬ë§·ëœ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = false;
                } else {
                    // í¬ë§·ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ì›ë³¸';
                    toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = true;
                }
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
            
            // í¬ë§·ëœ divì— íˆ´íŒ ì¶”ê°€
            const formattedContent = formattedDiv.querySelector('.formatted-op-history');
            if (formattedContent) {
                formattedContent.title = 'ë”ë¸”í´ë¦­í•˜ë©´ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            }
        }

        // ìŠ¤íŠ¸ë¦¬ë° ì½˜í…ì¸  ìƒì„±
        async function generateContent() {
            const selectedId = document.getElementById('idSelect').value;
            const selectedLlm = document.getElementById('llmSelect').value;
            const selectedLanguage = document.getElementById('languageSelect').value;
            
            const diagnosisSummarizationTextarea = document.getElementById('diagnosisSummarization');
            const opHistorySummarizationTextarea = document.getElementById('opHistorySummarization');
            const diagnosisListsTextarea = document.getElementById('diagnosisLists');
            const operationHistoryTextarea = document.getElementById('operationHistory');
            
            if (!selectedId) {
                alert('IDë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const generateBtn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            
            generateBtn.disabled = true;
            spinner.style.display = 'block';
            
            // í…ìŠ¤íŠ¸ ì˜ì—­ ì´ˆê¸°í™” ë° ê¸°ì¡´ í¬ë§· ì œê±°
            diagnosisSummarizationTextarea.value = '';
            opHistorySummarizationTextarea.value = '';
            
            // ê¸°ì¡´ í¬ë§·ëœ ë””ìŠ¤í”Œë ˆì´ ì œê±°
            [diagnosisSummarizationTextarea, opHistorySummarizationTextarea].forEach(textarea => {
                const parent = textarea.parentNode;
                const existingFormattedOp = parent.querySelector('.formatted-op-history');
                const existingFormattedDiag = parent.querySelector('.formatted-diagnosis');
                const existingToggle = parent.querySelector('.format-toggle-btn');
                if (existingFormattedOp) existingFormattedOp.remove();
                if (existingFormattedDiag) existingFormattedDiag.remove();
                if (existingToggle) existingToggle.remove();
                textarea.style.display = 'block'; // ì›ë³¸ textarea ë‹¤ì‹œ í‘œì‹œ
            });

            try {
                // ë¨¼ì € ì›ë³¸ ë°ì´í„° ë¡œë“œ (JSON í˜•íƒœë¡œ í‘œì‹œ)
                await loadOriginalData(selectedId, diagnosisListsTextarea, operationHistoryTextarea);
                
                // ë³‘ë ¬ë¡œ ë‘ ê°œì˜ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì‹œì‘
                const diagnosisPromise = streamDiagnosis(selectedId, selectedLlm, selectedLanguage, diagnosisSummarizationTextarea);
                const opHistoryPromise = streamOperationHistory(selectedId, selectedLlm, selectedLanguage, opHistorySummarizationTextarea);
                
                // ë‘ ìŠ¤íŠ¸ë¦¬ë°ì´ ëª¨ë‘ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await Promise.all([diagnosisPromise, opHistoryPromise]);
                
                // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ í¬ë§·íŒ… ì ìš©
                setTimeout(() => {
                    applyDiagnosisFormatting(diagnosisSummarizationTextarea);
                    applyOperationHistoryFormatting(opHistorySummarizationTextarea);
                }, 500); // ì•½ê°„ì˜ ì§€ì—° í›„ í¬ë§·íŒ… ì ìš©

            } catch (error) {
                console.error('Error during content generation:', error);
                diagnosisSummarizationTextarea.value = `Error: ${error.message}`;
                opHistorySummarizationTextarea.value = `Error: ${error.message}`;
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                generateBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        // ì›ë³¸ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        async function loadOriginalData(selectedId, diagnosisTextarea, operationTextarea) {
            try {
                // ì§„ë‹¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const diagnosisResponse = await fetch(`/api/diagnosis/${selectedId}`);
                if (diagnosisResponse.ok) {
                    const diagnosisData = await diagnosisResponse.json();
                    diagnosisTextarea.value = JSON.stringify(diagnosisData, null, 2);
                } else {
                    diagnosisTextarea.value = 'No diagnosis data available for this item.';
                }

                // ìš´ì˜ ì´ë ¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const operationResponse = await fetch(`/api/operation-history/${selectedId}`);
                if (operationResponse.ok) {
                    const contentType = operationResponse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        // ì¼ë°˜ JSON ì‘ë‹µ (ì§§ì€ ë°ì´í„°)
                        const operationData = await operationResponse.json();
                        operationTextarea.value = JSON.stringify(operationData, null, 2);
                    } else {
                        // ì˜ë¦° í…ìŠ¤íŠ¸ ì‘ë‹µ (ê¸´ ë°ì´í„°)
                        const operationText = await operationResponse.text();
                        operationTextarea.value = operationText;
                    }
                } else {
                    operationTextarea.value = 'No operation history data available for this item.';
                }
            } catch (error) {
                diagnosisTextarea.value = `Error loading data: ${error.message}`;
                operationTextarea.value = `Error loading data: ${error.message}`;
            }
        }

        // ì§„ë‹¨ ìŠ¤íŠ¸ë¦¬ë°
        async function streamDiagnosis(itemId, llm, language, textarea) {
            return new Promise((resolve, reject) => {
                const url = `/api/stream/diagnosis/${itemId}?llm=${llm}&language=${language}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function readStream() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    resolve();
                                    return;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            if (data.error) {
                                                textarea.value += `Error: ${data.error}`;
                                                reject(new Error(data.error));
                                                return;
                                            }
                                            if (data.chunk) {
                                                textarea.value += data.chunk;
                                            }
                                            if (data.done) {
                                                resolve();
                                                return;
                                            }
                                        } catch (e) {
                                            // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ (ë¶ˆì™„ì „í•œ ë°ì´í„°)
                                        }
                                    }
                                }
                                
                                readStream();
                            }).catch(reject);
                        }
                        
                        readStream();
                    })
                    .catch(reject);
            });
        }

        // ìš´ì˜ ì´ë ¥ ìŠ¤íŠ¸ë¦¬ë°
        async function streamOperationHistory(itemId, llm, language, textarea) {
            return new Promise((resolve, reject) => {
                const url = `/api/stream/operation-history/${itemId}?llm=${llm}&language=${language}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function readStream() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    resolve();
                                    return;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            if (data.error) {
                                                textarea.value += `Error: ${data.error}`;
                                                reject(new Error(data.error));
                                                return;
                                            }
                                            if (data.chunk) {
                                                textarea.value += data.chunk;
                                            }
                                            if (data.done) {
                                                resolve();
                                                return;
                                            }
                                        } catch (e) {
                                            // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ (ë¶ˆì™„ì „í•œ ë°ì´í„°)
                                        }
                                    }
                                }
                                
                                readStream();
                            }).catch(reject);
                        }
                        
                        readStream();
                    })
                    .catch(reject);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ JSON ë°ì´í„° ë¡œë“œ
        window.addEventListener('load', loadJsonData);
    </script>
</body>
</html>
