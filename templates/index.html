<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex-grow: 1;
        }

        .settings {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .setting-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .setting-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .control-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        select:hover {
            border-color: #007bff;
        }

        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .generate-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 20px;
        }

        .generate-btn:hover {
            background-color: #0056b3;
        }

        .generate-btn:active {
            transform: translateY(1px);
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 20px;
        }

        .top-textboxes {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .bottom-textboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .textbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

        .textbox-label {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        textarea {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            resize: vertical;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background-color: white;
        }

        .readonly {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-container {
            display: flex;
            align-items: center;
        }

        /* Formatted operation history styles */
        .formatted-op-history {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .formatted-op-history:hover {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background-color: white;
        }

        .op-history-title {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            font-weight: 600;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .op-history-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .op-history-item {
            margin: 12px 0;
            padding: 12px 15px;
            border-radius: 6px;
            position: relative;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .op-history-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .op-history-item.conclusion {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .op-history-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .op-history-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .op-history-item.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .op-history-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .op-history-text {
            display: inline;
        }

        .op-history-text strong {
            color: #2c3e50;
            font-weight: 600;
        }

        .op-history-text em {
            color: #6c757d;
            font-style: normal;
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .format-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .format-toggle-btn:hover {
            opacity: 1;
        }

        /* Formatted diagnosis styles - ìƒˆë¡œìš´ ë°•ìŠ¤ í˜•íƒœ */
        .formatted-diagnosis {
            line-height: 1.6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            transition: all 0.3s ease;
        }

        .formatted-diagnosis:hover {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: white;
        }

        .diagnosis-title {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.3em;
            font-weight: 600;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
            text-align: center;
        }

        /* ê²°ë¡  ìŠ¤íƒ€ì¼ */
        .diagnosis-conclusion {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .diagnosis-conclusion-label {
            font-weight: 700;
            font-size: 1.1em;
            color: #155724;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .diagnosis-conclusion-content {
            color: #155724;
            font-size: 1em;
            line-height: 1.5;
        }

        /* ì§„ë‹¨ í•­ëª©ë“¤ ì»¨í…Œì´ë„ˆ */
        .diagnosis-items {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        /* ê°œë³„ ì§„ë‹¨ í•­ëª© */
        .diagnosis-item {
            display: flex;
            align-items: flex-start;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #28a745;
            transition: all 0.2s ease;
        }

        .diagnosis-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateX(2px);
        }

        .diagnosis-item.normal {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #f0f8f0 100%);
        }

        .diagnosis-item.abnormal {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #f8f0f0 100%);
        }

        .diagnosis-item.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffef8 0%, #faf8f0 100%);
        }

        .diagnosis-item.info {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #f8feff 0%, #f0f8fa 100%);
        }

        .diagnosis-item.recommendation {
            border-left-color: #6f42c1;
            background: linear-gradient(135deg, #faf8ff 0%, #f5f0ff 100%);
        }

        /* ì§„ë‹¨ í•­ëª© ë²ˆí˜¸ */
        .diagnosis-item-number {
            background: #28a745;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1em;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .diagnosis-item.abnormal .diagnosis-item-number {
            background: #dc3545;
        }

        .diagnosis-item.warning .diagnosis-item-number {
            background: #ffc107;
            color: #212529;
        }

        .diagnosis-item.info .diagnosis-item-number {
            background: #17a2b8;
        }

        .diagnosis-item.recommendation .diagnosis-item-number {
            background: #6f42c1;
        }

        /* ì§„ë‹¨ í•­ëª© ë‚´ìš© */
        .diagnosis-item-content {
            flex: 1;
            color: #2c3e50;
            font-size: 0.95em;
            line-height: 1.5;
        }

        /* ì§„ë‹¨ ë©”ì¸ ë‚´ìš© */
        .diagnosis-main-content {
            margin-bottom: 8px;
        }

        /* ì§„ë‹¨ í•˜ìœ„ í•­ëª©ë“¤ */
        .diagnosis-sub-items {
            margin: 8px 0 0 0;
            padding-left: 20px;
            list-style: none;
        }

        .diagnosis-sub-item {
            position: relative;
            margin: 4px 0;
            padding-left: 15px;
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .diagnosis-sub-item::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            top: 0;
            color: #6c757d;
            font-weight: bold;
        }

        .diagnosis-sub-item:hover {
            color: #2c3e50;
        }

        /* ê¸°íƒ€ í•­ëª©ë“¤ */
        .diagnosis-other-items {
            display: grid;
            gap: 10px;
        }

        .diagnosis-other-item {
            background: white;
            border-radius: 6px;
            padding: 12px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 3px solid #6c757d;
            transition: all 0.2s ease;
        }

        .diagnosis-other-item:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transform: translateX(1px);
        }

        .diagnosis-other-item.normal {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #f0f8f0 100%);
        }

        .diagnosis-other-item.abnormal {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #f8f0f0 100%);
        }

        .diagnosis-other-item.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffef8 0%, #faf8f0 100%);
        }

        .diagnosis-other-item.info {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #f8feff 0%, #f0f8fa 100%);
        }

        .diagnosis-other-item.recommendation {
            border-left-color: #6f42c1;
            background: linear-gradient(135deg, #faf8ff 0%, #f5f0ff 100%);
        }

        .diagnosis-other-content {
            color: #2c3e50;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Readability Report Styles */
        .readability-section {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border-left: 4px solid #007bff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            width: 100%;
            box-sizing: border-box;
            order: 10; /* ê°€ë…ì„± ì„¹ì…˜ì„ ê°€ì¥ ì•„ë˜ë¡œ */
        }

        .readability-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .readability-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .readability-toggle {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .readability-toggle:hover {
            background: #0056b3;
        }

        .readability-content {
            line-height: 1.6;
        }

        .readability-overall {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-weight: 600;
        }

        .readability-overall.good {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .readability-overall.poor {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .readability-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .readability-metric {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .readability-metric .icon {
            font-size: 1.1em;
        }

        .readability-terms {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .readability-terms-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .readability-terms-list {
            color: #6c757d;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .readability-recommendations {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
        }

        .readability-recommendations-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .readability-recommendations ul {
            margin: 0;
            padding-left: 20px;
            color: #856404;
        }

        .readability-recommendations li {
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .readability-collapsed {
            display: none;
        }

        @media (max-width: 768px) {
            .readability-metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">HRM AI Agent</h1>
            <div class="settings">
                <div class="setting-group">
                    <label class="setting-label">LLM:</label>
                    <select id="llmSelect">
                        <option value="aws">AWS</option>
                        <option value="openai">OpenAI</option>
                        <option value="gauss">Gauss</option>
                        <option value="gausso">Gausso</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Language:</label>
                    <select id="languageSelect">
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">Product:</label>
                <select id="productSelect">
                    <option value="airconditioner">Airconditioner</option>
                    <option value="refrigerator">Refrigerator</option>
                    <option value="washer">Washer</option>
                </select>
            </div>
            <div class="control-group">
                <label class="control-label">ID:</label>
                <select id="idSelect">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="button-container">
                <button class="generate-btn" id="generateBtn" onclick="generateContent()">Generation</button>
                <div class="spinner" id="loadingSpinner"></div>
            </div>
        </div>

        <div class="content-area">
            <div class="top-textboxes">
                <div class="textbox-group">
                    <label class="textbox-label">Diagnosis Summarization</label>
                    <textarea id="diagnosisSummarization" placeholder="AIê°€ ìƒì„±í•œ ì§„ë‹¨ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">Op. History Summarization</label>
                    <textarea id="opHistorySummarization" placeholder="AIê°€ ìƒì„±í•œ ìš´ì˜ ì´ë ¥ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">User Guide</label>
                    <textarea id="userGuide" placeholder="AIê°€ ìƒì„±í•œ ì‚¬ìš©ì ê°€ì´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
            <div class="bottom-textboxes">
                <div class="textbox-group">
                    <label class="textbox-label">Diagnosis Lists</label>
                    <textarea id="diagnosisLists" class="readonly" readonly placeholder="ì„ íƒëœ ì œí’ˆì˜ ì§„ë‹¨ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
                <div class="textbox-group">
                    <label class="textbox-label">Operation History</label>
                    <textarea id="operationHistory" class="readonly" readonly placeholder="ì„ íƒëœ ì œí’ˆì˜ ìš´ì˜ ì´ë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let jsonData = [];

        // JSON ë°ì´í„° ë¡œë“œ
        async function loadJsonData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                jsonData = await response.json();
                console.log('JSON data loaded:', jsonData.length, 'items');
                updateIdOptions();
            } catch (error) {
                console.error('Error loading JSON data:', error);
                document.getElementById('idSelect').innerHTML = '<option value="">Error loading data</option>';
            }
        }

        // ID ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateIdOptions() {
            const productSelect = document.getElementById('productSelect');
            const idSelect = document.getElementById('idSelect');
            const selectedProduct = productSelect.value;
            
            // ì„ íƒëœ ì œí’ˆì— í•´ë‹¹í•˜ëŠ” IDë“¤ í•„í„°ë§
            const filteredData = jsonData.filter(item => {
                if (selectedProduct === 'airconditioner') {
                    return item.id.startsWith('airconditioner_');
                } else if (selectedProduct === 'refrigerator') {
                    return item.id.startsWith('refrigerator_');
                } else if (selectedProduct === 'washer') {
                    return item.id.startsWith('washer_');
                }
                return false;
            });

            // ID ì˜µì…˜ ìƒì„±
            idSelect.innerHTML = '';
            if (filteredData.length > 0) {
                filteredData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.id;
                    idSelect.appendChild(option);
                });
            } else {
                // í•´ë‹¹ ì œí’ˆ íƒ€ì…ì˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                for (let i = 1; i <= 25; i++) {
                    const option = document.createElement('option');
                    const idNumber = String(i).padStart(3, '0');
                    option.value = `${selectedProduct}_${idNumber}`;
                    option.textContent = `${selectedProduct}_${idNumber}`;
                    idSelect.appendChild(option);
                }
            }
        }

        // ì œí’ˆ ë³€ê²½ ì‹œ ID ì˜µì…˜ ì—…ë°ì´íŠ¸
        document.getElementById('productSelect').addEventListener('change', updateIdOptions);

        // ì§„ë‹¨ ìš”ì•½ í›„ì²˜ë¦¬ í•¨ìˆ˜ (ì•„ì´ì½˜ ì—†ëŠ” ë°•ìŠ¤ í˜•íƒœ)
        function formatDiagnosisSummary(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            
            let lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            // ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì–¸ì–´ í‚¤ì›Œë“œ ì œê±°
            if (lines.length > 0) {
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // ì–¸ì–´ í‚¤ì›Œë“œ íŒ¨í„´ë“¤
                    const languagePatterns = [
                        /^í•œêµ­ì–´[:ï¼š\s]*(.*)$/gi,
                        /^ì˜ì–´[:ï¼š\s]*(.*)$/gi,
                        /^English[:ï¼š\s]*(.*)$/gi,
                        /^Korean[:ï¼š\s]*(.*)$/gi,
                        /^í•œê¸€[:ï¼š\s]*(.*)$/gi,
                        /^korean[:ï¼š\s]*(.*)$/gi,
                        /^english[:ï¼š\s]*(.*)$/gi,
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]+(.+)$/gi,
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]*$/gi
                    ];
                    
                    let cleanedLine = line;
                    let wasLanguageLine = false;
                    
                    for (const pattern of languagePatterns) {
                        const match = cleanedLine.match(pattern);
                        if (match) {
                            if (match[1] && match[1].trim()) {
                                cleanedLine = match[1].trim();
                            } else if (match[2] && match[2].trim()) {
                                cleanedLine = match[2].trim();
                            } else {
                                wasLanguageLine = true;
                                break;
                            }
                            break;
                        }
                    }
                    
                    if (!wasLanguageLine && cleanedLine && cleanedLine.length > 0) {
                        processedLines.push(cleanedLine);
                    }
                }
                
                lines = processedLines;
            }
            
            // ê²°ë¡  ë¶€ë¶„ê³¼ ë²ˆí˜¸ê°€ ìˆëŠ” í•­ëª©ë“¤ ë¶„ë¦¬
            let conclusionLine = '';
            let numberedItems = [];
            let otherItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                const trimmedLine = lines[i].trim();
                if (trimmedLine === '') continue;
                
                // ë²ˆí˜¸ê°€ ìˆëŠ” ì¤„ ì°¾ê¸° (1., 2., 3. ë“±)
                const numberedMatch = trimmedLine.match(/^(\d+)\.\s*(.+)/);
                if (numberedMatch) {
                    // ë²ˆí˜¸ê°€ ìˆëŠ” í•­ëª© ìƒì„±
                    const item = {
                        number: numberedMatch[1],
                        content: numberedMatch[2],
                        subItems: []
                    };
                    
                    // ë‹¤ìŒ ì¤„ë“¤ì—ì„œ í•˜ì´í”ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê´€ë ¨ ë‚´ìš© ì°¾ê¸°
                    let j = i + 1;
                    while (j < lines.length) {
                        const nextLine = lines[j].trim();
                        if (nextLine === '') {
                            j++;
                            continue;
                        }
                        
                        // í•˜ì´í”ˆìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ì´ê±°ë‚˜ ë“¤ì—¬ì“°ê¸°ëœ ì¤„
                        if (nextLine.match(/^[-â€“â€”â€¢]\s*(.+)/) || nextLine.match(/^\s+[-â€“â€”â€¢]\s*(.+)/) || 
                            (nextLine.match(/^\s{2,}(.+)/) && !nextLine.match(/^\d+\.\s/))) {
                            item.subItems.push(nextLine);
                            j++;
                        } else if (nextLine.match(/^\d+\.\s/)) {
                            // ë‹¤ìŒ ë²ˆí˜¸ í•­ëª©ì„ ë§Œë‚˜ë©´ ì¤‘ë‹¨
                            break;
                        } else {
                            // ì¼ë°˜ í…ìŠ¤íŠ¸ì§€ë§Œ ë²ˆí˜¸ í•­ëª©ì´ ì•„ë‹ˆë©´ í•˜ìœ„ í•­ëª©ìœ¼ë¡œ í¬í•¨
                            item.subItems.push(nextLine);
                            j++;
                        }
                    }
                    
                    numberedItems.push(item);
                    i = j - 1; // ì²˜ë¦¬í•œ ì¤„ë“¤ ê±´ë„ˆë›°ê¸°
                } else if (i === 0 && !numberedMatch) {
                    // ì²« ë²ˆì§¸ ì¤„ì´ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ê²°ë¡ ìœ¼ë¡œ ì²˜ë¦¬
                    conclusionLine = trimmedLine;
                } else {
                    // ê·¸ ì™¸ í•­ëª©ë“¤ (ë²ˆí˜¸ í•­ëª©ì— í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ)
                    let isPartOfNumberedItem = false;
                    
                    // ì´ë¯¸ ë²ˆí˜¸ í•­ëª©ì— í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    for (let item of numberedItems) {
                        if (item.subItems.includes(trimmedLine)) {
                            isPartOfNumberedItem = true;
                            break;
                        }
                    }
                    
                    if (!isPartOfNumberedItem) {
                        otherItems.push(trimmedLine);
                    }
                }
            }
            
            let result = `
                <div class="formatted-diagnosis">
                    <h3 class="diagnosis-title">
                        <span>ì§„ë‹¨ ë¶„ì„ ê²°ê³¼</span>
                    </h3>
            `;
            
            // ê²°ë¡  ë¶€ë¶„ í‘œì‹œ
            if (conclusionLine) {
                const processedConclusion = processTextFormatting(conclusionLine);
                result += `
                    <div class="diagnosis-conclusion">
                        <div class="diagnosis-conclusion-label">ê²°ë¡ </div>
                        <div class="diagnosis-conclusion-content">${processedConclusion}</div>
                    </div>
                `;
            }
            
            // ë²ˆí˜¸ê°€ ìˆëŠ” í•­ëª©ë“¤ í‘œì‹œ
            if (numberedItems.length > 0) {
                result += `<div class="diagnosis-items">`;
                
                numberedItems.forEach(item => {
                    const processedContent = processTextFormatting(item.content);
                    let cssClass = getDiagnosisItemClass(item.content);
                    
                    // í•˜ìœ„ í•­ëª©ë“¤ ì²˜ë¦¬
                    let subItemsHtml = '';
                    if (item.subItems && item.subItems.length > 0) {
                        subItemsHtml = '<ul class="diagnosis-sub-items">';
                        item.subItems.forEach(subItem => {
                            const processedSubItem = processTextFormatting(subItem);
                            // í•˜ì´í”ˆì´ë‚˜ ë¶ˆë¦¿ í¬ì¸íŠ¸ ì œê±°í•˜ê³  ì •ë¦¬
                            const cleanSubItem = processedSubItem.replace(/^[-â€“â€”â€¢]\s*/, '').replace(/^\s+[-â€“â€”â€¢]\s*/, '').trim();
                            subItemsHtml += `<li class="diagnosis-sub-item">${cleanSubItem}</li>`;
                        });
                        subItemsHtml += '</ul>';
                    }
                    
                    result += `
                        <div class="diagnosis-item ${cssClass}">
                            <div class="diagnosis-item-number">${item.number}</div>
                            <div class="diagnosis-item-content">
                                <div class="diagnosis-main-content">${processedContent}</div>
                                ${subItemsHtml}
                            </div>
                        </div>
                    `;
                });
                
                result += `</div>`;
            }
            
            // ê¸°íƒ€ í•­ëª©ë“¤ í‘œì‹œ
            if (otherItems.length > 0) {
                result += `<div class="diagnosis-other-items">`;
                
                otherItems.forEach(item => {
                    const processedContent = processTextFormatting(item);
                    let cssClass = getDiagnosisItemClass(item);
                    
                    result += `
                        <div class="diagnosis-other-item ${cssClass}">
                            <div class="diagnosis-other-content">${processedContent}</div>
                        </div>
                    `;
                });
                
                result += `</div>`;
            }
            
            result += `</div>`;
            
            return result;
        }
        
        // ì§„ë‹¨ í•­ëª©ì˜ CSS í´ë˜ìŠ¤ ê²°ì • (í‚¤ì›Œë“œ ê¸°ë°˜)
        function getDiagnosisItemClass(content) {
            const lowerContent = content.toLowerCase();
            
            if (lowerContent.includes('ì •ìƒ') || lowerContent.includes('normal') || 
                lowerContent.includes('ì–‘í˜¸') || lowerContent.includes('good') ||
                lowerContent.includes('ë¬¸ì œì—†ìŒ') || lowerContent.includes('ì •ìƒ ë™ì‘')) {
                return 'normal';
            } else if (lowerContent.includes('ì´ìƒ') || lowerContent.includes('abnormal') || 
                      lowerContent.includes('ë¬¸ì œ') || lowerContent.includes('ì˜¤ë¥˜') || 
                      lowerContent.includes('error') || lowerContent.includes('fault') ||
                      lowerContent.includes('ê³ ì¥') || lowerContent.includes('ë¶ˆëŸ‰')) {
                return 'abnormal';
            } else if (lowerContent.includes('ê¶Œì¥') || lowerContent.includes('recommend') || 
                      lowerContent.includes('ì¡°ì¹˜') || lowerContent.includes('action') ||
                      lowerContent.includes('ê°œì„ ') || lowerContent.includes('improve') ||
                      lowerContent.includes('êµì²´') || lowerContent.includes('ì²­ì†Œ') ||
                      lowerContent.includes('ì ê²€') || lowerContent.includes('í™•ì¸')) {
                return 'recommendation';
            } else if (lowerContent.includes('ì£¼ì˜') || lowerContent.includes('warning') || 
                      lowerContent.includes('ê²½ê³ ') || lowerContent.includes('alert') ||
                      lowerContent.includes('ìœ„í—˜') || lowerContent.includes('risk')) {
                return 'warning';
            } else {
                return 'info';
            }
        }

        // ì§„ë‹¨ í¬ë§·íŒ… ì ìš© í•¨ìˆ˜
        function applyDiagnosisFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            
            const parent = textarea.parentNode;
            
            // ê¸°ì¡´ í¬ë§·ëœ ìš”ì†Œë“¤ ì œê±° (ê°€ë…ì„± ì„¹ì…˜ì€ ìœ ì§€)
            const existingFormatted = parent.querySelector('.formatted-diagnosis');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existingFormatted) existingFormatted.remove();
            if (existingToggle) existingToggle.remove();
            
            // í¬ë§·ëœ div ìƒì„±
            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatDiagnosisSummary(rawText);
            
            // í† ê¸€ ë²„íŠ¼ ìƒì„±
            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ì›ë³¸';
            toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°';
            
            // ê°€ë…ì„± ì„¹ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
            const readabilitySection = parent.querySelector('.readability-section');
            
            // textarea ìˆ¨ê¸°ê³  í¬ë§·ëœ divì™€ ë²„íŠ¼ ì¶”ê°€
            textarea.style.display = 'none';
            
            // ê°€ë…ì„± ì„¹ì…˜ì´ ìˆìœ¼ë©´ ê·¸ ì•ì— ì¶”ê°€, ì—†ìœ¼ë©´ ë§¨ ë’¤ì— ì¶”ê°€
            if (readabilitySection) {
                parent.insertBefore(formattedDiv, readabilitySection);
                parent.insertBefore(toggleButton, readabilitySection);
            } else {
                parent.appendChild(formattedDiv);
                parent.appendChild(toggleButton);
            }
            
            // í† ê¸€ ê¸°ëŠ¥
            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'í¬ë§·';
                    toggleButton.title = 'í¬ë§·ëœ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = false;
                } else {
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ì›ë³¸';
                    toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = true;
                }
            }
            
            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
            
            const formattedContent = formattedDiv.querySelector('.formatted-diagnosis');
            if (formattedContent) {
                formattedContent.title = 'ë”ë¸”í´ë¦­í•˜ë©´ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            }
        }

        // ìš´ì˜ ì´ë ¥ ìš”ì•½ í›„ì²˜ë¦¬ í•¨ìˆ˜
        function formatOperationHistorySummary(rawText) {
            if (!rawText || rawText.trim() === '') return '';
            
            // HTML ì—”í‹°í‹° ì´ìŠ¤ì¼€ì´í”„
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            let lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            // ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì–¸ì–´ í‚¤ì›Œë“œ ì œê±° (ê°•í™”ëœ ë²„ì „)
            if (lines.length > 0) {
                let processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // ì–¸ì–´ í‚¤ì›Œë“œ íŒ¨í„´ë“¤ (ë” í¬ê´„ì )
                    const languagePatterns = [
                        /^í•œêµ­ì–´[:ï¼š\s]*(.*)$/gi,
                        /^ì˜ì–´[:ï¼š\s]*(.*)$/gi,
                        /^English[:ï¼š\s]*(.*)$/gi,
                        /^Korean[:ï¼š\s]*(.*)$/gi,
                        /^í•œê¸€[:ï¼š\s]*(.*)$/gi,
                        /^korean[:ï¼š\s]*(.*)$/gi,
                        /^english[:ï¼š\s]*(.*)$/gi,
                        // ì¤„ ì‹œì‘ ë¶€ë¶„ì˜ ì–¸ì–´ í‚¤ì›Œë“œ
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]+(.+)$/gi,
                        // ì¤„ ì „ì²´ê°€ ì–¸ì–´ í‚¤ì›Œë“œì¸ ê²½ìš°
                        /^(í•œêµ­ì–´|ì˜ì–´|English|Korean|í•œê¸€|korean|english)[:ï¼š\-\s]*$/gi
                    ];
                    
                    let cleanedLine = line;
                    let wasLanguageLine = false;
                    
                    // ê° íŒ¨í„´ì„ í™•ì¸í•˜ì—¬ ì–¸ì–´ í‚¤ì›Œë“œ ì œê±°
                    for (const pattern of languagePatterns) {
                        const match = cleanedLine.match(pattern);
                        if (match) {
                            if (match[1] && match[1].trim()) {
                                // ì–¸ì–´ í‚¤ì›Œë“œ ë’¤ì— ë‚´ìš©ì´ ìˆìœ¼ë©´ ê·¸ ë‚´ìš©ë§Œ ìœ ì§€
                                cleanedLine = match[1].trim();
                            } else if (match[2] && match[2].trim()) {
                                // ë‘ ë²ˆì§¸ ìº¡ì²˜ ê·¸ë£¹ì— ë‚´ìš©ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                                cleanedLine = match[2].trim();
                            } else {
                                // ì–¸ì–´ í‚¤ì›Œë“œë§Œ ìˆê³  ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì´ ì¤„ì„ ê±´ë„ˆëœ€
                                wasLanguageLine = true;
                                break;
                            }
                            break;
                        }
                    }
                    
                    // ìœ íš¨í•œ ë‚´ìš©ì´ ìˆëŠ” ì¤„ë§Œ ì¶”ê°€
                    if (!wasLanguageLine && cleanedLine && cleanedLine.length > 0) {
                        processedLines.push(cleanedLine);
                    }
                }
                
                lines = processedLines;
            }
            
            let result = `
                <div class="formatted-op-history">
                    <h3 class="op-history-title">
                        <span>ğŸ”</span>
                        <span>ìš´ì˜ ì´ë ¥ ë¶„ì„ ê²°ê³¼</span>
                        <span style="margin-left: auto; font-size: 0.8em; color: #6c757d;">ğŸ“ˆ</span>
                    </h3>
                    <ul class="op-history-list">
            `;
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') return;
                
                let cssClass = '';
                let icon = 'â–¶';
                let processedLine = trimmedLine;
                
                // ë²ˆí˜¸ê°€ ìˆëŠ” ì¤„ ì²˜ë¦¬ (1., 2., 3. ë“±)
                const numberedMatch = processedLine.match(/^(\d+)\.\s*(.+)/);
                if (numberedMatch) {
                    processedLine = numberedMatch[2];
                    
                    // ì²« ë²ˆì§¸ í•­ëª©ì€ ë³´í†µ ê²°ë¡ 
                    if (numberedMatch[1] === '1') {
                        cssClass = 'conclusion';
                        icon = 'âœ“';
                    }
                }
                
                // í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ë¥˜ ë° ì•„ì´ì½˜ ì„¤ì • (ê°œì„ ëœ ë²„ì „)
                const lowerLine = processedLine.toLowerCase();
                
                // ì •ìƒ/ì„±ê³µ ìƒíƒœ
                if (lowerLine.includes('ì •ìƒ') || lowerLine.includes('normal') || 
                    lowerLine.includes('ì„±ê³µ') || lowerLine.includes('ì™„ë£Œ') || 
                    lowerLine.includes('ì–‘í˜¸') || lowerLine.includes('success')) {
                    cssClass = 'conclusion';
                    icon = 'âœ…';
                    
                // ì˜¤ë¥˜/ë¬¸ì œ ìƒíƒœ  
                } else if (lowerLine.includes('ì´ìƒ') || lowerLine.includes('abnormal') || 
                          lowerLine.includes('ë¬¸ì œ') || lowerLine.includes('ì˜¤ë¥˜') || 
                          lowerLine.includes('error') || lowerLine.includes('fault') ||
                          lowerLine.includes('ì‹¤íŒ¨') || lowerLine.includes('ê³ ì¥')) {
                    cssClass = 'error';
                    icon = 'ğŸš¨';
                    
                // ê²½ê³ /ì£¼ì˜ ìƒíƒœ
                } else if (lowerLine.includes('ì£¼ì˜') || lowerLine.includes('warning') || 
                          lowerLine.includes('í™•ì¸') || lowerLine.includes('ì ê²€') ||
                          lowerLine.includes('ê¶Œì¥') || lowerLine.includes('recommend') ||
                          lowerLine.includes('ì•Œë¦¼') || lowerLine.includes('notice')) {
                    cssClass = 'warning';
                    icon = 'âš ï¸';
                    
                // ì˜¨ë„ ê´€ë ¨
                } else if (lowerLine.includes('ì˜¨ë„') || lowerLine.includes('temperature') ||
                          lowerLine.includes('â„ƒ') || lowerLine.includes('Â°c') ||
                          lowerLine.includes('ì—´') || lowerLine.includes('ëƒ‰ê°')) {
                    cssClass = 'info';
                    icon = 'ğŸŒ¡ï¸';
                    
                // ì „ë ¥/ì—ë„ˆì§€ ê´€ë ¨
                } else if (lowerLine.includes('ì „ë ¥') || lowerLine.includes('power') ||
                          lowerLine.includes('ì—ë„ˆì§€') || lowerLine.includes('energy') ||
                          lowerLine.includes('kw') || lowerLine.includes('ì „ê¸°')) {
                    cssClass = 'info';
                    icon = 'âš¡';
                    
                // ì‹œê°„/ì£¼ê¸° ê´€ë ¨
                } else if (lowerLine.includes('ì‹œê°„') || lowerLine.includes('time') ||
                          lowerLine.includes('ì£¼ê¸°') || lowerLine.includes('cycle') ||
                          lowerLine.includes('ë¶„') || lowerLine.includes('ì´ˆ')) {
                    cssClass = 'info';
                    icon = 'â°';
                    
                // ë°ì´í„°/ì •ë³´ ê´€ë ¨
                } else if (lowerLine.includes('ë°ì´í„°') || lowerLine.includes('ì •ë³´') || 
                          lowerLine.includes('ì¸¡ì •') || lowerLine.includes('ê¸°ë¡') ||
                          lowerLine.includes('data') || lowerLine.includes('info') ||
                          lowerLine.includes('ë¡œê·¸') || lowerLine.includes('ê¸°ë¡')) {
                    cssClass = 'info';
                    icon = 'ğŸ“Š';
                    
                // ë¶€ì¡±/ì—†ìŒ ìƒíƒœ
                } else if (lowerLine.includes('ë¶€ì¡±') || lowerLine.includes('ì—†ìŒ') ||
                          lowerLine.includes('insufficient') || lowerLine.includes('lack') ||
                          lowerLine.includes('missing') || lowerLine.includes('ë¶€ì¬')) {
                    cssClass = 'warning';
                    icon = 'ğŸ“‰';
                    
                // ê¸°ë³¸ ì•„ì´ì½˜ (ì²« ë²ˆì§¸ í•­ëª©ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬)
                } else if (numberedMatch && numberedMatch[1] === '1') {
                    cssClass = 'conclusion';
                    icon = 'ğŸ';
                }
                
                // í…ìŠ¤íŠ¸ ê°•ì¡° ì²˜ë¦¬
                processedLine = processTextFormatting(processedLine);
                
                result += `
                    <li class="op-history-item ${cssClass}">
                        <span class="op-history-icon">${icon}</span>
                        <span class="op-history-text">${processedLine}</span>
                    </li>
                `;
            });
            
            result += `
                    </ul>
                </div>
            `;
            
            return result;
        }

        // í…ìŠ¤íŠ¸ í¬ë§·íŒ… ì²˜ë¦¬ (ê°•ì¡°, ìˆ˜ì¹˜ ë“±) - ê°œì„ ëœ ë²„ì „
        function processTextFormatting(text) {
            let processed = escapeHtml(text);
            
            // ê°•ì¡° í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼)
            processed = processed.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #2c3e50;">$1</strong>');
            processed = processed.replace(/\*(.+?)\*/g, '<em style="color: #6c757d; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">$1</em>');
            
            // ìˆ˜ì¹˜ì™€ ë‹¨ìœ„ í•˜ì´ë¼ì´íŠ¸ (ë” í¬ê´„ì )
            processed = processed.replace(/(\d+(?:\.\d+)?)\s*(â„ƒ|Â°C|ë„|ì‹œê°„|ë¶„|ì´ˆ|%|Hz|rpm|kW|W|A|V|bar|Pa|L\/min|mÂ³\/h|dB)/gi, 
                '<strong style="color: #007bff; background: #e7f3ff; padding: 1px 4px; border-radius: 3px;">$1$2</strong>');
            
            // ë‚ ì§œì™€ ì‹œê°„ ê°•ì¡°
            processed = processed.replace(/(\d{4}-\d{2}-\d{2}|\d{2}:\d{2}(?::\d{2})?)/g, 
                '<em style="color: #17a2b8; background: #d1ecf1; padding: 1px 4px; border-radius: 3px;">$1</em>');
            
            // ìƒíƒœ í‚¤ì›Œë“œ ê°•ì¡° (ë” ë‹¤ì–‘í•œ í‚¤ì›Œë“œ)
            processed = processed.replace(/(ì •ìƒ|ì´ìƒ|ê²½ê³ |ì˜¤ë¥˜|ë¬¸ì œ|ì„±ê³µ|ì‹¤íŒ¨|ì™„ë£Œ|ì§„í–‰ì¤‘|ëŒ€ê¸°|Normal|Abnormal|Warning|Error|Success|Failed|Complete|Progress|Pending)/gi, 
                function(match) {
                    const lower = match.toLowerCase();
                    let color = '#2c3e50';
                    let bgColor = '#f8f9fa';
                    
                    if (lower.includes('ì •ìƒ') || lower.includes('normal') || lower.includes('ì„±ê³µ') || lower.includes('success') || lower.includes('ì™„ë£Œ') || lower.includes('complete')) {
                        color = '#28a745';
                        bgColor = '#d4edda';
                    } else if (lower.includes('ì´ìƒ') || lower.includes('abnormal') || lower.includes('ì˜¤ë¥˜') || lower.includes('error') || lower.includes('ì‹¤íŒ¨') || lower.includes('failed') || lower.includes('ë¬¸ì œ')) {
                        color = '#dc3545';
                        bgColor = '#f8d7da';
                    } else if (lower.includes('ê²½ê³ ') || lower.includes('warning') || lower.includes('ì£¼ì˜')) {
                        color = '#fd7e14';
                        bgColor = '#fff3cd';
                    }
                    
                    return `<strong style="color: ${color}; background: ${bgColor}; padding: 2px 6px; border-radius: 4px; font-weight: 600;">${match}</strong>`;
                });
            
            // í¼ì„¼í…Œì´ì§€ ê°•ì¡°
            processed = processed.replace(/(\d+(?:\.\d+)?%)/g, 
                '<strong style="color: #6f42c1; background: #e7e3ff; padding: 1px 4px; border-radius: 3px;">$1</strong>');
            
            // ë²”ìœ„ í‘œí˜„ ê°•ì¡° (ì˜ˆ: 20-25â„ƒ, 1-5ë¶„)
            processed = processed.replace(/(\d+(?:\.\d+)?)\s*[-~]\s*(\d+(?:\.\d+)?)\s*([â„ƒÂ°CFminì´ˆë¶„ì‹œê°„])/gi,
                '<strong style="color: #20c997; background: #d1f2eb; padding: 1px 4px; border-radius: 3px;">$1-$2$3</strong>');
            
            return processed;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í¬ë§·íŒ… ì ìš© í•¨ìˆ˜
        function applyOperationHistoryFormatting(textarea) {
            const rawText = textarea.value;
            if (!rawText || rawText.trim() === '') return;
            
            const parent = textarea.parentNode;
            
            // ê¸°ì¡´ í¬ë§·ëœ ìš”ì†Œë“¤ ì œê±°
            const existingFormatted = parent.querySelector('.formatted-op-history');
            const existingToggle = parent.querySelector('.format-toggle-btn');
            if (existingFormatted) existingFormatted.remove();
            if (existingToggle) existingToggle.remove();
            
            // í¬ë§·ëœ div ìƒì„±
            const formattedDiv = document.createElement('div');
            formattedDiv.innerHTML = formatOperationHistorySummary(rawText);
            
            // í† ê¸€ ë²„íŠ¼ ìƒì„±
            const toggleButton = document.createElement('button');
            toggleButton.className = 'format-toggle-btn';
            toggleButton.textContent = 'ì›ë³¸';
            toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°';
            
            // textarea ìˆ¨ê¸°ê³  í¬ë§·ëœ divì™€ ë²„íŠ¼ ì¶”ê°€
            textarea.style.display = 'none';
            parent.appendChild(formattedDiv);
            parent.appendChild(toggleButton);
            
            // í† ê¸€ ê¸°ëŠ¥
            let showingFormatted = true;
            function toggleDisplay() {
                if (showingFormatted) {
                    // ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
                    textarea.style.display = 'block';
                    formattedDiv.style.display = 'none';
                    toggleButton.textContent = 'í¬ë§·';
                    toggleButton.title = 'í¬ë§·ëœ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = false;
                } else {
                    // í¬ë§·ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
                    textarea.style.display = 'none';
                    formattedDiv.style.display = 'block';
                    toggleButton.textContent = 'ì›ë³¸';
                    toggleButton.title = 'ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°ë¡œ ì „í™˜';
                    showingFormatted = true;
                }
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            toggleButton.addEventListener('click', toggleDisplay);
            formattedDiv.addEventListener('dblclick', toggleDisplay);
            
            // í¬ë§·ëœ divì— íˆ´íŒ ì¶”ê°€
            const formattedContent = formattedDiv.querySelector('.formatted-op-history');
            if (formattedContent) {
                formattedContent.title = 'ë”ë¸”í´ë¦­í•˜ë©´ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            }
        }

        // ìŠ¤íŠ¸ë¦¬ë° ì½˜í…ì¸  ìƒì„±
        async function generateContent() {
            const selectedId = document.getElementById('idSelect').value;
            const selectedLlm = document.getElementById('llmSelect').value;
            const selectedLanguage = document.getElementById('languageSelect').value;
            
            const diagnosisSummarizationTextarea = document.getElementById('diagnosisSummarization');
            const opHistorySummarizationTextarea = document.getElementById('opHistorySummarization');
            const diagnosisListsTextarea = document.getElementById('diagnosisLists');
            const operationHistoryTextarea = document.getElementById('operationHistory');
            
            if (!selectedId) {
                alert('IDë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const generateBtn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            
            generateBtn.disabled = true;
            spinner.style.display = 'block';
            
            // í…ìŠ¤íŠ¸ ì˜ì—­ ì´ˆê¸°í™” ë° ê¸°ì¡´ í¬ë§· ì œê±°
            diagnosisSummarizationTextarea.value = '';
            opHistorySummarizationTextarea.value = '';
            
            // ê¸°ì¡´ í¬ë§·ëœ ë””ìŠ¤í”Œë ˆì´ ì œê±°
            [diagnosisSummarizationTextarea, opHistorySummarizationTextarea].forEach(textarea => {
                const parent = textarea.parentNode;
                const existingFormattedOp = parent.querySelector('.formatted-op-history');
                const existingFormattedDiag = parent.querySelector('.formatted-diagnosis');
                const existingToggle = parent.querySelector('.format-toggle-btn');
                const existingReadability = parent.querySelector('.readability-section');
                if (existingFormattedOp) existingFormattedOp.remove();
                if (existingFormattedDiag) existingFormattedDiag.remove();
                if (existingToggle) existingToggle.remove();
                if (existingReadability) existingReadability.remove(); // ê¸°ì¡´ ê°€ë…ì„± ì„¹ì…˜ë„ ì œê±°
                textarea.style.display = 'block'; // ì›ë³¸ textarea ë‹¤ì‹œ í‘œì‹œ
            });

            try {
                // ë¨¼ì € ì›ë³¸ ë°ì´í„° ë¡œë“œ (JSON í˜•íƒœë¡œ í‘œì‹œ)
                await loadOriginalData(selectedId, diagnosisListsTextarea, operationHistoryTextarea);
                
                // ë³‘ë ¬ë¡œ ë‘ ê°œì˜ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì‹œì‘
                const diagnosisPromise = streamDiagnosis(selectedId, selectedLlm, selectedLanguage, diagnosisSummarizationTextarea);
                const opHistoryPromise = streamOperationHistory(selectedId, selectedLlm, selectedLanguage, opHistorySummarizationTextarea);
                
                // ë‘ ìŠ¤íŠ¸ë¦¬ë°ì´ ëª¨ë‘ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await Promise.all([diagnosisPromise, opHistoryPromise]);
                
                // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ í¬ë§·íŒ… ì ìš© (ì§„ë‹¨ê³¼ ìš´ì˜ ì´ë ¥ ëª¨ë‘)
                setTimeout(() => {
                    applyDiagnosisFormatting(diagnosisSummarizationTextarea);
                    applyOperationHistoryFormatting(opHistorySummarizationTextarea);
                }, 500); // ì•½ê°„ì˜ ì§€ì—° í›„ í¬ë§·íŒ… ì ìš©

            } catch (error) {
                console.error('Error during content generation:', error);
                diagnosisSummarizationTextarea.value = `Error: ${error.message}`;
                opHistorySummarizationTextarea.value = `Error: ${error.message}`;
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                generateBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        // ì›ë³¸ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        async function loadOriginalData(selectedId, diagnosisTextarea, operationTextarea) {
            try {
                // ì§„ë‹¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const diagnosisResponse = await fetch(`/api/diagnosis/${selectedId}`);
                if (diagnosisResponse.ok) {
                    const diagnosisData = await diagnosisResponse.json();
                    diagnosisTextarea.value = JSON.stringify(diagnosisData, null, 2);
                } else {
                    diagnosisTextarea.value = 'No diagnosis data available for this item.';
                }

                // ìš´ì˜ ì´ë ¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const operationResponse = await fetch(`/api/operation-history/${selectedId}`);
                if (operationResponse.ok) {
                    const contentType = operationResponse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        // ì¼ë°˜ JSON ì‘ë‹µ (ì§§ì€ ë°ì´í„°)
                        const operationData = await operationResponse.json();
                        operationTextarea.value = JSON.stringify(operationData, null, 2);
                    } else {
                        // ì˜ë¦° í…ìŠ¤íŠ¸ ì‘ë‹µ (ê¸´ ë°ì´í„°)
                        const operationText = await operationResponse.text();
                        operationTextarea.value = operationText;
                    }
                } else {
                    operationTextarea.value = 'No operation history data available for this item.';
                }
            } catch (error) {
                diagnosisTextarea.value = `Error loading data: ${error.message}`;
                operationTextarea.value = `Error loading data: ${error.message}`;
            }
        }

        // ì§„ë‹¨ ìŠ¤íŠ¸ë¦¬ë°
        async function streamDiagnosis(itemId, llm, language, textarea) {
            return new Promise((resolve, reject) => {
                const url = `/api/stream/diagnosis/${itemId}?llm=${llm}&language=${language}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function readStream() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ê°€ë…ì„± ë³´ê³ ì„œ ì²˜ë¦¬
                                    processReadabilityReport(textarea);
                                    resolve();
                                    return;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            if (data.error) {
                                                textarea.value += `Error: ${data.error}`;
                                                reject(new Error(data.error));
                                                return;
                                            }
                                            if (data.chunk) {
                                                textarea.value += data.chunk;
                                            }
                                            if (data.done) {
                                                // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ê°€ë…ì„± ë³´ê³ ì„œ ì²˜ë¦¬
                                                processReadabilityReport(textarea);
                                                resolve();
                                                return;
                                            }
                                        } catch (e) {
                                            // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ (ë¶ˆì™„ì „í•œ ë°ì´í„°)
                                        }
                                    }
                                }
                                
                                readStream();
                            }).catch(reject);
                        }
                        
                        readStream();
                    })
                    .catch(reject);
            });
        }

        // ìš´ì˜ ì´ë ¥ ìŠ¤íŠ¸ë¦¬ë°
        async function streamOperationHistory(itemId, llm, language, textarea) {
            return new Promise((resolve, reject) => {
                const url = `/api/stream/operation-history/${itemId}?llm=${llm}&language=${language}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        function readStream() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ê°€ë…ì„± ë³´ê³ ì„œ ì²˜ë¦¬
                                    processReadabilityReport(textarea);
                                    resolve();
                                    return;
                                }
                                
                                const chunk = decoder.decode(value);
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.slice(6));
                                            if (data.error) {
                                                textarea.value += `Error: ${data.error}`;
                                                reject(new Error(data.error));
                                                return;
                                            }
                                            if (data.chunk) {
                                                textarea.value += data.chunk;
                                            }
                                            if (data.done) {
                                                // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ê°€ë…ì„± ë³´ê³ ì„œ ì²˜ë¦¬
                                                processReadabilityReport(textarea);
                                                resolve();
                                                return;
                                            }
                                        } catch (e) {
                                            // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ (ë¶ˆì™„ì „í•œ ë°ì´í„°)
                                        }
                                    }
                                }
                                
                                readStream();
                            }).catch(reject);
                        }
                        
                        readStream();
                    })
                    .catch(reject);
            });
        }

        // ê°€ë…ì„± ë³´ê³ ì„œ ì²˜ë¦¬ í•¨ìˆ˜
        function processReadabilityReport(textarea) {
            const content = textarea.value;
            
            // ê°€ë…ì„± ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ ì°¾ê¸°
            const reportStartIndex = content.indexOf('ğŸ“Š **ê°€ë…ì„± ë¶„ì„ ê²°ê³¼**');
            if (reportStartIndex === -1) {
                return; // ê°€ë…ì„± ë³´ê³ ì„œê°€ ì—†ìœ¼ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            }
            
            // ì›ë³¸ ë‚´ìš©ê³¼ ê°€ë…ì„± ë³´ê³ ì„œ ë¶„ë¦¬
            const originalContent = content.substring(0, reportStartIndex).trim();
            const reportContent = content.substring(reportStartIndex).trim();
            
            // ê°€ë…ì„± ë³´ê³ ì„œ íŒŒì‹±
            const readabilityData = parseReadabilityReport(reportContent);
            
            // ì›ë³¸ ë‚´ìš©ë§Œ textareaì— ìœ ì§€
            textarea.value = originalContent;
            
            // ê°€ë…ì„± ì„¹ì…˜ ìƒì„± ë° í‘œì‹œ
            createReadabilitySection(textarea, readabilityData);
        }

        function parseReadabilityReport(reportText) {
            const data = {
                overall: 'unknown',
                metrics: {},
                technicalTerms: [],
                recommendations: []
            };
            
            try {
                // ì¢…í•© í‰ê°€ íŒŒì‹±
                const overallMatch = reportText.match(/ğŸ¯ \*\*ì¢…í•© í‰ê°€\*\*: (âœ…|âŒ) (ì–‘í˜¸|ê°œì„  í•„ìš”)/);
                if (overallMatch) {
                    data.overall = overallMatch[2] === 'ì–‘í˜¸' ? 'good' : 'poor';
                }
                
                // ì„¸ë¶€ ë¶„ì„ íŒŒì‹±
                const metricsSection = reportText.match(/ğŸ“‹ \*\*ì„¸ë¶€ ë¶„ì„\*\*:([\s\S]*?)(?=ğŸ”|\ğŸ’¡|$)/);
                if (metricsSection) {
                    const metricsText = metricsSection[1];
                    
                    // ê°œì¡°ì‹ í˜•íƒœ
                    const bulletMatch = metricsText.match(/â€¢ ê°œì¡°ì‹ í˜•íƒœ: (âœ…|âŒ) (\d+)ê°œ í•­ëª© \((ì–‘í˜¸|ê°œì„  í•„ìš”)\)/);
                    if (bulletMatch) {
                        data.metrics.bullet = {
                            icon: bulletMatch[1],
                            count: parseInt(bulletMatch[2]),
                            status: bulletMatch[3]
                        };
                    }
                    
                    // ë‹¨ì–´ ìˆ˜
                    const wordMatch = metricsText.match(/â€¢ ë‹¨ì–´ ìˆ˜: (âœ…|âŒ) (\d+)ê°œ ë‹¨ì–´ \((ì–‘í˜¸|ê°œì„  í•„ìš”)\)/);
                    if (wordMatch) {
                        data.metrics.words = {
                            icon: wordMatch[1],
                            count: parseInt(wordMatch[2]),
                            status: wordMatch[3]
                        };
                    }
                    
                    // ìš©ì–´ ë‚œì´ë„
                    const termsMatch = metricsText.match(/â€¢ ìš©ì–´ ë‚œì´ë„: (âœ…|âŒ) ì „ë¬¸ìš©ì–´ ([\d.]+)% \((ì–‘í˜¸|ê°œì„  í•„ìš”)\)/);
                    if (termsMatch) {
                        data.metrics.terms = {
                            icon: termsMatch[1],
                            ratio: parseFloat(termsMatch[2]),
                            status: termsMatch[3]
                        };
                    }
                    
                    // ê°€ë…ì„± ì ìˆ˜
                    const scoreMatch = metricsText.match(/â€¢ ê°€ë…ì„± ì ìˆ˜: (âœ…|âŒ) FK (\d+)ì  \((ì–‘í˜¸|ê°œì„  í•„ìš”)\)/);
                    if (scoreMatch) {
                        data.metrics.score = {
                            icon: scoreMatch[1],
                            value: parseInt(scoreMatch[2]),
                            status: scoreMatch[3]
                        };
                    }
                }
                
                // ë°œê²¬ëœ ì „ë¬¸ìš©ì–´ íŒŒì‹±
                const termsMatch = reportText.match(/ğŸ” \*\*ë°œê²¬ëœ ì „ë¬¸ìš©ì–´\*\*: (.+)/);
                if (termsMatch) {
                    data.technicalTerms = termsMatch[1].split(', ').map(term => term.trim());
                }
                
                // ê°œì„  ê¶Œì¥ì‚¬í•­ íŒŒì‹±
                const recommendationsMatch = reportText.match(/ğŸ’¡ \*\*ê°œì„  ê¶Œì¥ì‚¬í•­\*\*:([\s\S]*?)$/);
                if (recommendationsMatch) {
                    const recommendationsText = recommendationsMatch[1];
                    const recommendations = recommendationsText.match(/â€¢ ([^\n]+)/g);
                    if (recommendations) {
                        data.recommendations = recommendations.map(rec => rec.replace('â€¢ ', '').trim());
                    }
                }
                
            } catch (error) {
                console.error('ê°€ë…ì„± ë³´ê³ ì„œ íŒŒì‹± ì˜¤ë¥˜:', error);
            }
            
            return data;
        }

        function createReadabilitySection(textarea, data) {
            const parent = textarea.parentNode; // textbox-group
            
            // ê¸°ì¡´ ê°€ë…ì„± ì„¹ì…˜ ì œê±°
            const existingSection = parent.querySelector('.readability-section');
            if (existingSection) {
                existingSection.remove();
            }
            
            // ìƒˆ ê°€ë…ì„± ì„¹ì…˜ ìƒì„±
            const section = document.createElement('div');
            section.className = 'readability-section';
            section.style.marginTop = '15px'; // textareaì™€ ê°„ê²© í™•ë³´
            
            const overallClass = data.overall === 'good' ? 'good' : 'poor';
            const overallText = data.overall === 'good' ? 'ì–‘í˜¸' : 'ê°œì„  í•„ìš”';
            const overallIcon = data.overall === 'good' ? 'âœ…' : 'âŒ';
            
            let metricsHtml = '';
            if (data.metrics.bullet) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.bullet.icon}</span>
                        <span>ê°œì¡°ì‹ ${data.metrics.bullet.count}ê°œ í•­ëª©</span>
                    </div>
                `;
            }
            if (data.metrics.words) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.words.icon}</span>
                        <span>${data.metrics.words.count}ê°œ ë‹¨ì–´</span>
                    </div>
                `;
            }
            if (data.metrics.terms) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.terms.icon}</span>
                        <span>ì „ë¬¸ìš©ì–´ ${data.metrics.terms.ratio}%</span>
                    </div>
                `;
            }
            if (data.metrics.score) {
                metricsHtml += `
                    <div class="readability-metric">
                        <span class="icon">${data.metrics.score.icon}</span>
                        <span>ê°€ë…ì„± ${data.metrics.score.value}ì </span>
                    </div>
                `;
            }
            
            let technicalTermsHtml = '';
            if (data.technicalTerms.length > 0) {
                technicalTermsHtml = `
                    <div class="readability-terms">
                        <div class="readability-terms-title">ğŸ” ë°œê²¬ëœ ì „ë¬¸ìš©ì–´</div>
                        <div class="readability-terms-list">${data.technicalTerms.join(', ')}</div>
                    </div>
                `;
            }
            
            let recommendationsHtml = '';
            if (data.recommendations.length > 0) {
                const recommendationsList = data.recommendations.map(rec => `<li>${rec}</li>`).join('');
                recommendationsHtml = `
                    <div class="readability-recommendations">
                        <div class="readability-recommendations-title">
                            <span>ğŸ’¡</span>
                            <span>ê°œì„  ê¶Œì¥ì‚¬í•­</span>
                        </div>
                        <ul>${recommendationsList}</ul>
                    </div>
                `;
            }
            
            section.innerHTML = `
                <div class="readability-header">
                    <div class="readability-title">
                        <span>ğŸ“Š</span>
                        <span>ê°€ë…ì„± ë¶„ì„ ê²°ê³¼</span>
                    </div>
                    <button class="readability-toggle" onclick="toggleReadabilitySection(this)">ì ‘ê¸°</button>
                </div>
                <div class="readability-content">
                    <div class="readability-overall ${overallClass}">
                        <span>${overallIcon}</span>
                        <span>ì¢…í•© í‰ê°€: ${overallText}</span>
                    </div>
                    <div class="readability-metrics">
                        ${metricsHtml}
                    </div>
                    ${technicalTermsHtml}
                    ${recommendationsHtml}
                </div>
            `;
            
            // textbox-groupì˜ ë§¨ ë§ˆì§€ë§‰ì— ê°€ë…ì„± ì„¹ì…˜ ì¶”ê°€ (textarea ì•„ë˜)
            parent.appendChild(section);
        }

        function toggleReadabilitySection(button) {
            const content = button.closest('.readability-section').querySelector('.readability-content');
            const isCollapsed = content.classList.contains('readability-collapsed');
            
            if (isCollapsed) {
                content.classList.remove('readability-collapsed');
                button.textContent = 'ì ‘ê¸°';
            } else {
                content.classList.add('readability-collapsed');
                button.textContent = 'í¼ì¹˜ê¸°';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ JSON ë°ì´í„° ë¡œë“œ
        window.addEventListener('load', loadJsonData);
    </script>
</body>
</html>
